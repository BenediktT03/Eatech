<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung erfolgreich - Pizza&Pasta D'amico</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Additional Styles f√ºr Fixes */
        .notification-banner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            z-index: 1000;
            min-width: 300px;
        }
        
        .notification-banner.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .notification-banner.ready {
            border-left: 5px solid #27ae60;
        }
        
        .notification-banner.info {
            border-left: 5px solid #3498db;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-content i {
            font-size: 1.5rem;
            color: #3498db;
        }
        
        .notification-banner.ready i {
            color: #27ae60;
        }
        
        .error-container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 50px auto;
        }
        
        .error-container h2 {
            color: #e74c3c;
            margin: 20px 0 10px;
        }
        
        .error-container p {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .step-icon.completed {
            background: #27ae60;
            color: white;
        }
        
        .step-icon.active {
            background: #f39c12;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(243, 156, 18, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0);
            }
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üçï Pizza&Pasta D'amico</h1>
            </div>
        </div>
    </header>

    <!-- Success Container -->
    <div class="order-success-container">
        <div class="success-card">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            
            <h1 data-i18n="success.title">Bestellung erfolgreich!</h1>
            <p class="success-message" data-i18n="success.message">
                Vielen Dank f√ºr Ihre Bestellung. Wir bereiten Ihr Essen frisch zu.
            </p>
            
            <!-- Order Details -->
            <div class="order-details-card">
                <h2 data-i18n="success.details">Bestelldetails</h2>
                
                <div class="detail-row">
                    <span class="detail-label" data-i18n="success.orderNumber">Bestellnummer:</span>
                    <span class="detail-value" id="orderId">-</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label" data-i18n="success.customer">Kunde:</span>
                    <span class="detail-value" id="customerName">-</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label" data-i18n="success.waitTime">Gesch√§tzte Wartezeit:</span>
                    <span class="detail-value" id="estimatedTime">-</span>
                </div>
                
                <div class="order-items" id="orderItemsList">
                    <!-- Dynamisch geladen -->
                </div>
                
                <div class="detail-row total-row">
                    <span class="detail-label" data-i18n="success.total">Gesamt:</span>
                    <span class="detail-value" id="orderTotal">CHF 0.00</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label" data-i18n="success.payment">Zahlungsmethode:</span>
                    <span class="detail-value" id="paymentMethod">-</span>
                </div>
            </div>
            
            <!-- Order Status Tracker -->
            <div class="status-tracker">
                <h3 data-i18n="success.status">Bestellstatus</h3>
                
                <div class="status-steps">
                    <div class="status-step">
                        <div class="step-icon active" id="step-ordered">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <span data-i18n="status.ordered">Bestellt</span>
                    </div>
                    
                    <div class="status-line"></div>
                    
                    <div class="status-step">
                        <div class="step-icon" id="step-preparing">
                            <i class="fas fa-fire"></i>
                        </div>
                        <span data-i18n="status.preparing">Zubereitung</span>
                    </div>
                    
                    <div class="status-line"></div>
                    
                    <div class="status-step">
                        <div class="step-icon" id="step-ready">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span data-i18n="status.ready">Fertig</span>
                    </div>
                </div>
                
                <p class="status-message" id="statusMessage">Ihre Bestellung wurde angenommen</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="index.html" class="btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span data-i18n="success.backToMenu">Zur√ºck zum Men√º</span>
                </a>
                <a href="#" id="trackingLink" class="btn-primary">
                    <i class="fas fa-search"></i>
                    <span data-i18n="success.trackOrder">Bestellung verfolgen</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Push Notification Info -->
    <div class="notification-info">
        <i class="fas fa-bell"></i>
        <p data-i18n="success.notificationInfo">
            Sie erhalten eine Benachrichtigung, wenn Ihre Bestellung fertig ist.
        </p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Multilingual Support -->
    <script src="js/multilingual.js"></script>

    <script>
        // Firebase Konfiguration - DEINE ECHTEN DATEN
        const firebaseConfig = {
            apiKey: "AIzaSyBiVdp67AZmZnGpM8OlZXBGKJKhF4iDlsE",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.appspot.com",
            messagingSenderId: "168976461234",
            appId: "1:168976461234:web:abc123def456ghi789"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Globale Variablen
        let currentOrderId = null;
        let currentOrder = null;

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Success Page wird initialisiert...');
            
            // Multilingual
            if (window.ml) {
                window.ml.init();
            }
            
            // Notification Permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Order laden
            loadOrderDetails();
        });

        // Order ID aus URL holen
        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Verschiedene M√∂glichkeiten
            return urlParams.get('order') || 
                   urlParams.get('orderId') || 
                   urlParams.get('id') ||
                   urlParams.get('session_id'); // F√ºr Stripe
        }

        // Bestellung laden
        async function loadOrderDetails() {
            currentOrderId = getOrderIdFromUrl();
            
            if (!currentOrderId) {
                showError('Keine Bestellnummer gefunden');
                return;
            }
            
            try {
                // Zuerst in temp-orders suchen (Stripe)
                let orderRef = database.ref(`temp-orders/${currentOrderId}`);
                let snapshot = await orderRef.once('value');
                let orderData = snapshot.val();
                
                if (orderData) {
                    // Von temp zu echten Orders verschieben
                    const realOrderId = orderData.id || currentOrderId.slice(-6).toUpperCase();
                    const newOrderRef = await database.ref('orders').push({
                        ...orderData,
                        id: realOrderId,
                        status: 'neu',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        paymentStatus: 'paid',
                        paymentMethod: orderData.paymentMethod || 'stripe'
                    });
                    
                    // Temp l√∂schen
                    await orderRef.remove();
                    
                    // Mit neuer ID weiter
                    currentOrderId = newOrderRef.key;
                    orderData.id = realOrderId;
                } else {
                    // In normalen Orders suchen
                    orderRef = database.ref(`orders/${currentOrderId}`);
                    snapshot = await orderRef.once('value');
                    orderData = snapshot.val();
                }
                
                if (!orderData) {
                    showError('Bestellung nicht gefunden');
                    return;
                }
                
                currentOrder = orderData;
                displayOrderDetails(orderData);
                setupRealtimeTracking(currentOrderId);
                
                // Tracking Link setzen
                const trackingLink = document.getElementById('trackingLink');
                if (trackingLink) {
                    trackingLink.href = `track.html?order=${currentOrderId}`;
                }
                
            } catch (error) {
                console.error('Error loading order:', error);
                showError('Fehler beim Laden der Bestellung');
            }
        }

        // Bestelldetails anzeigen
        function displayOrderDetails(order) {
            // Order ID
            document.getElementById('orderId').textContent = order.id || currentOrderId.slice(-6).toUpperCase();
            
            // Kunde
            document.getElementById('customerName').textContent = order.customerName || 'Gast';
            
            // Wartezeit
            const waitTime = order.estimatedWaitTime || 15;
            document.getElementById('estimatedTime').textContent = `${waitTime} Minuten`;
            
            // Bestellpositionen
            const itemsList = document.getElementById('orderItemsList');
            if (order.items && order.items.length > 0) {
                itemsList.innerHTML = order.items.map(item => `
                    <div class="order-item">
                        <span>${item.quantity || 1}x ${item.name}</span>
                        <span>CHF ${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                    </div>
                `).join('');
            }
            
            // Total
            document.getElementById('orderTotal').textContent = `CHF ${(order.total || 0).toFixed(2)}`;
            
            // Zahlungsmethode
            const methods = {
                'stripe': 'Kreditkarte',
                'cash': 'Barzahlung',
                'twint': 'TWINT'
            };
            document.getElementById('paymentMethod').textContent = methods[order.paymentMethod] || 'Bezahlt';
        }

        // Realtime Tracking
        function setupRealtimeTracking(orderId) {
            // Status Updates
            database.ref(`orders/${orderId}/status`).on('value', (snapshot) => {
                const status = snapshot.val() || 'neu';
                updateOrderStatus(status);
            });
            
            // Notifications
            database.ref(`notifications/${orderId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                if (notification) {
                    handleNotification(notification);
                }
            });
        }

        // Status Update
        function updateOrderStatus(status) {
            const steps = {
                'neu': 1,
                'zubereitung': 2,
                'fertig': 3
            };
            
            const currentStep = steps[status] || 1;
            
            // Step Icons updaten
            const stepOrdered = document.getElementById('step-ordered');
            const stepPreparing = document.getElementById('step-preparing');
            const stepReady = document.getElementById('step-ready');
            
            // Reset
            stepOrdered.className = 'step-icon';
            stepPreparing.className = 'step-icon';
            stepReady.className = 'step-icon';
            
            // Aktuelle und abgeschlossene Steps
            if (currentStep >= 1) stepOrdered.className = 'step-icon completed';
            if (currentStep >= 2) stepPreparing.className = 'step-icon completed';
            if (currentStep >= 3) stepReady.className = 'step-icon completed';
            
            // Aktiver Step
            if (currentStep === 1 && status === 'neu') stepOrdered.className = 'step-icon active';
            if (currentStep === 2) stepPreparing.className = 'step-icon active';
            if (currentStep === 3) stepReady.className = 'step-icon active';
            
            // Status Message
            const messages = {
                'neu': 'Ihre Bestellung wurde angenommen und wird vorbereitet',
                'zubereitung': 'Ihre Bestellung wird gerade frisch zubereitet',
                'fertig': 'üéâ Ihre Bestellung ist fertig! Bitte abholen.'
            };
            
            const messageElement = document.getElementById('statusMessage');
            if (messageElement) {
                messageElement.textContent = messages[status] || 'Status unbekannt';
                
                if (status === 'fertig') {
                    messageElement.style.color = '#27ae60';
                    messageElement.style.fontWeight = 'bold';
                    messageElement.style.fontSize = '1.2em';
                }
            }
        }

        // Notification Handler
        function handleNotification(notification) {
            // Banner anzeigen
            showNotificationBanner(notification.message, notification.type);
            
            // Sound abspielen
            if (notification.sound) {
                playNotificationSound();
            }
            
            // Browser Notification
            if (Notification.permission === 'granted') {
                new Notification('Pizza&Pasta D\'amico', {
                    body: notification.message,
                    icon: '/icon-192x192.png',
                    badge: '/icon-192x192.png',
                    vibrate: [200, 100, 200],
                    tag: 'order-update'
                });
            }
        }

        // Notification Banner
        function showNotificationBanner(message, type = 'info') {
            const existingBanner = document.querySelector('.notification-banner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            const banner = document.createElement('div');
            banner.className = `notification-banner ${type}`;
            banner.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'ready' ? 'bell' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            // Animate in
            setTimeout(() => banner.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                banner.classList.remove('show');
                setTimeout(() => banner.remove(), 300);
            }, 5000);
        }

        // Sound abspielen
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBDGH0fPTgjMGHm7A7+OZURE');
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.error('Sound error:', e);
            }
        }

        // Error anzeigen
        function showError(message) {
            const container = document.querySelector('.order-success-container');
            container.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #e74c3c;"></i>
                    <h2>Fehler</h2>
                    <p>${message}</p>
                    <button onclick="window.location.href='index.html'" class="btn-primary">
                        Zur√ºck zur Startseite
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>