<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung erfolgreich - Pizza&Pasta D'amico</title>
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body>
    <!-- Language Selector -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header success-header">
            <div class="status-emoji">✅</div>
            <h1 data-i18n="success.title">Bestellung erfolgreich!</h1>
            <p class="subtitle" data-i18n="success.subtitle">Vielen Dank für Ihre Bestellung</p>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Order Info -->
            <div class="order-info-card">
                <h2 class="section-title">
                    <i class="fas fa-receipt"></i>
                    <span data-i18n="success.orderDetails">Bestelldetails</span>
                </h2>
                
                <div class="order-details">
                    <div class="detail-row">
                        <span class="detail-label" data-i18n="success.orderNumber">Bestellnummer:</span>
                        <span class="detail-value order-number" id="orderNumber">#000000</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label" data-i18n="success.customer">Kunde:</span>
                        <span class="detail-value" id="customerName">-</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label" data-i18n="success.waitTime">Geschätzte Wartezeit:</span>
                        <span class="detail-value">
                            <i class="fas fa-clock"></i>
                            <span id="waitTime">-</span> <span data-i18n="success.minutes">Minuten</span>
                        </span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label" data-i18n="success.payment">Zahlungsmethode:</span>
                        <span class="detail-value" id="paymentMethod">-</span>
                    </div>
                </div>
            </div>

            <!-- Status Tracker -->
            <div class="status-tracker">
                <h3 class="section-title">
                    <i class="fas fa-tasks"></i>
                    <span data-i18n="success.status">Bestellstatus</span>
                </h3>
                
                <div class="status-steps">
                    <div class="status-step">
                        <div class="step-icon active" id="step-ordered">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <span data-i18n="status.ordered">Bestellt</span>
                    </div>
                    
                    <div class="status-line"></div>
                    
                    <div class="status-step">
                        <div class="step-icon" id="step-preparing">
                            <i class="fas fa-fire"></i>
                        </div>
                        <span data-i18n="status.preparing">Zubereitung</span>
                    </div>
                    
                    <div class="status-line"></div>
                    
                    <div class="status-step">
                        <div class="step-icon" id="step-ready">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span data-i18n="status.ready">Fertig</span>
                    </div>
                </div>
                
                <div class="status-message" id="statusMessage">
                    <i class="fas fa-info-circle"></i>
                    <span data-i18n="status.messageNew">Ihre Bestellung wurde angenommen</span>
                </div>
            </div>

            <!-- Order Items -->
            <div class="order-items-section">
                <h3 class="section-title">
                    <i class="fas fa-list"></i>
                    <span data-i18n="success.items">Bestellte Artikel</span>
                </h3>
                
                <div class="order-items-list" id="orderItemsList">
                    <!-- Wird dynamisch gefüllt -->
                </div>
                
                <div class="order-total-section">
                    <div class="order-total">
                        <span data-i18n="success.total">Gesamtbetrag:</span>
                        <span id="orderTotal">CHF 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span data-i18n="success.backToMenu">Zurück zum Menü</span>
                </a>
                <a href="#" id="trackingLink" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                    <span data-i18n="success.trackOrder">Bestellung verfolgen</span>
                </a>
            </div>

            <!-- Push Notification Info -->
            <div class="notification-info">
                <i class="fas fa-bell"></i>
                <p data-i18n="success.notificationInfo">
                    Sie erhalten eine Benachrichtigung, wenn Ihre Bestellung fertig ist.
                </p>
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div class="notification" id="notificationPopup">
        <div class="notification-content">
            <i class="fas fa-bell"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
  apiKey: "AIzaSyD3OCMvc4Iup58Ao0BiFNuvA0fnJokzYS8",
  authDomain: "pizzapastadamico.firebaseapp.com",
  databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pizzapastadamico",
  storageBucket: "pizzapastadamico.firebasestorage.app",
  messagingSenderId: "83240541532",
  appId: "1:83240541532:web:11e3277850bf89a5b8b599",
  measurementId: "G-6H2J5K88J7"
};

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Globale Variablen
        let currentOrderId = null;
        let currentOrder = null;
        let notificationSound = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load multilingual
            if (window.ml) {
                window.ml.init();
            }
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Initialize notification sound
            notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBi+Bz/LXijMHFGS97OehTQ0MW6zn775mJAYwe8vz2oU8CRdmvOzpoVMQDViP7OukRhEKTaPf8sNuLAUme8v02Ag/BxNUr+3btp');
            
            // Load order details
            loadOrderDetails();
        });

        // Get Order ID from URL
        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('order') || urlParams.get('orderId') || urlParams.get('id');
        }

        // Load Order Details
        function loadOrderDetails() {
            currentOrderId = getOrderIdFromUrl();
            
            if (!currentOrderId) {
                showError();
                return;
            }
            
            // Load order from Firebase
            database.ref(`orders/${currentOrderId}`).once('value', (snapshot) => {
                currentOrder = snapshot.val();
                
                if (!currentOrder) {
                    showError();
                    return;
                }
                
                displayOrderDetails();
                startStatusListener();
            });
        }

        // Display Order Details
        function displayOrderDetails() {
            // Order number
            document.getElementById('orderNumber').textContent = `#${currentOrderId.slice(-6).toUpperCase()}`;
            
            // Customer name
            document.getElementById('customerName').textContent = currentOrder.customerName || currentOrder.name || 'Gast';
            
            // Wait time
            const waitTime = currentOrder.waitTime || calculateWaitTime();
            document.getElementById('waitTime').textContent = waitTime;
            
            // Payment method
            const paymentMethod = currentOrder.paymentMethod || 'cash';
            const paymentTexts = {
                'card': 'Kartenzahlung',
                'cash': 'Barzahlung',
                'twint': 'TWINT'
            };
            document.getElementById('paymentMethod').textContent = paymentTexts[paymentMethod] || paymentMethod;
            
            // Order items
            if (currentOrder.items && currentOrder.items.length > 0) {
                const itemsList = document.getElementById('orderItemsList');
                itemsList.innerHTML = currentOrder.items.map(item => `
                    <div class="order-item">
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-quantity">${item.quantity}x CHF ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="item-total">CHF ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `).join('');
            }
            
            // Total
            const total = currentOrder.total || 0;
            document.getElementById('orderTotal').textContent = `CHF ${total.toFixed(2)}`;
            
            // Update tracking link
            document.getElementById('trackingLink').href = `track.html?order=${currentOrderId}`;
            
            // Update status if already set
            if (currentOrder.status) {
                updateOrderStatus(currentOrder.status);
            }
        }

        // Start Status Listener
        function startStatusListener() {
            // Listen to status changes
            database.ref(`orders/${currentOrderId}/status`).on('value', (snapshot) => {
                const status = snapshot.val() || 'neu';
                updateOrderStatus(status);
            });
            
            // Listen to notifications
            database.ref(`notifications/${currentOrderId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                if (notification) {
                    handleNotification(notification);
                }
            });
        }

        // Update Order Status
        function updateOrderStatus(status) {
            const steps = {
                'neu': 1,
                'zubereitung': 2,
                'fertig': 3
            };
            
            const currentStep = steps[status] || 1;
            
            // Update step icons
            const stepOrdered = document.getElementById('step-ordered');
            const stepPreparing = document.getElementById('step-preparing');
            const stepReady = document.getElementById('step-ready');
            
            // Reset classes
            stepOrdered.className = 'step-icon';
            stepPreparing.className = 'step-icon';
            stepReady.className = 'step-icon';
            
            // Set completed steps
            if (currentStep >= 1) stepOrdered.className = 'step-icon completed';
            if (currentStep >= 2) stepPreparing.className = 'step-icon completed';
            if (currentStep >= 3) stepReady.className = 'step-icon completed';
            
            // Set active step
            if (currentStep === 1 && status === 'neu') stepOrdered.className = 'step-icon active';
            if (currentStep === 2) stepPreparing.className = 'step-icon active';
            if (currentStep === 3) stepReady.className = 'step-icon active';
            
            // Update status message
            const messages = {
                'neu': 'Ihre Bestellung wurde angenommen und wird vorbereitet',
                'zubereitung': 'Ihre Bestellung wird gerade frisch zubereitet',
                'fertig': '🎉 Ihre Bestellung ist fertig! Bitte abholen.'
            };
            
            const messageEl = document.getElementById('statusMessage');
            messageEl.innerHTML = `
                <i class="fas fa-${status === 'fertig' ? 'check-circle' : 'info-circle'}"></i>
                <span>${messages[status] || 'Status wird aktualisiert...'}</span>
            `;
            
            if (status === 'fertig') {
                messageEl.className = 'status-message ready';
            }
        }

        // Handle Notification
        function handleNotification(notification) {
            // Show popup
            showNotificationPopup(notification.message);
            
            // Play sound if requested
            if (notification.playSound && notificationSound) {
                notificationSound.play().catch(e => console.log('Sound play failed:', e));
            }
            
            // Show browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Pizza&Pasta D\'amico', {
                    body: notification.message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🍕</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🍕</text></svg>'
                });
            }
        }

        // Show Notification Popup
        function showNotificationPopup(message) {
            const popup = document.getElementById('notificationPopup');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            popup.className = 'notification show';
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 5000);
        }

        // Calculate Wait Time
        function calculateWaitTime() {
            if (!currentOrder.items) return 5;
            
            const itemCount = currentOrder.items.reduce((sum, item) => sum + item.quantity, 0);
            if (itemCount < 6) return 5;
            if (itemCount <= 11) return 10;
            return Math.min(15 + Math.floor((itemCount - 11) / 3) * 5, 30);
        }

        // Show Error
        function showError() {
            document.querySelector('.content').innerHTML = `
                <div class="error-state">
                    <div class="status-emoji">❌</div>
                    <h2 class="status-title">Bestellung nicht gefunden</h2>
                    <p class="status-description">
                        Die angeforderte Bestellung konnte nicht gefunden werden.
                        Bitte überprüfen Sie die Bestellnummer.
                    </p>
                    <a href="index.html" class="btn btn-primary">
                        <i class="fas fa-home"></i>
                        <span>Zur Startseite</span>
                    </a>
                </div>
            `;
        }
    </script>
</body>
</html>