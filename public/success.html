<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung best√§tigt - Pizza&Pasta D'amico</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="js/multilingual.js"></script>
    
    <style>
        .success-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .success-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 3rem;
            color: white;
            animation: successPulse 2s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .success-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 15px;
        }

        .success-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 40px;
        }

        .order-details-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
            text-align: left;
        }

        .order-id {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 20px;
            text-align: center;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .detail-value {
            color: #ffffff;
            font-weight: 600;
        }

        .detail-value.amount {
            color: #22c55e;
            font-size: 1.1rem;
        }

        .status-tracker {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .status-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .status-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .step-icon.active {
            background: #22c55e;
            color: white;
        }

        .step-icon.pending {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }

        .step-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .step-line {
            position: absolute;
            top: 25px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .status-step:last-child .step-line {
            display: none;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .instructions {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #3b82f6;
        }

        .instructions h4 {
            color: #3b82f6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .instructions li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #22c55e;
            font-weight: bold;
        }

        .payment-info {
            background: rgba(34, 197, 94, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .payment-success {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #22c55e;
            font-weight: 600;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .success-container {
                padding: 15px;
            }
            
            .success-title {
                font-size: 2rem;
            }
            
            .actions {
                grid-template-columns: 1fr;
            }
            
            .status-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .step-line {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="pizza-loader" id="pizzaLoader">
        <div class="spinning-pizza">üçï</div>
        <div class="loading-text">Bestellung wird verarbeitet...</div>
        <div class="loading-subtext">Einen Moment bitte...</div>
    </div>

    <div class="success-container">
        <!-- Success Icon -->
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>

        <!-- Success Message -->
        <h1 class="success-title">Bestellung best√§tigt!</h1>
        <p class="success-subtitle">Vielen Dank f√ºr Ihre Bestellung bei Pizza&Pasta D'amico</p>

        <!-- Payment Success Info -->
        <div class="payment-info" id="paymentInfo" style="display: none;">
            <div class="payment-success">
                <i class="fas fa-credit-card"></i>
                <span>Zahlung erfolgreich verarbeitet</span>
            </div>
        </div>

        <!-- Order Details -->
        <div class="order-details-card">
            <div class="order-id" id="orderIdDisplay">
                Bestellung #<span id="orderNumber">---</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Bestellzeit:</span>
                <span class="detail-value" id="orderTime">--:--</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Gesch√§tzte Wartezeit:</span>
                <span class="detail-value" id="waitTime">-- Min</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Zahlungsmethode:</span>
                <span class="detail-value" id="paymentMethod">---</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Gesamtbetrag:</span>
                <span class="detail-value amount" id="totalAmount">CHF 0.00</span>
            </div>
        </div>

        <!-- Status Tracker -->
        <div class="status-tracker">
            <h4 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">
                <i class="fas fa-tasks"></i> Bestellstatus
            </h4>
            <div class="status-steps">
                <div class="status-step">
                    <div class="step-icon active">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">Bestellt</div>
                    <div class="step-line"></div>
                </div>
                <div class="status-step">
                    <div class="step-icon pending" id="preparingIcon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="step-label">Zubereitung</div>
                    <div class="step-line"></div>
                </div>
                <div class="status-step">
                    <div class="step-icon pending" id="readyIcon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="step-label">Fertig</div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h4><i class="fas fa-info-circle"></i> Was passiert jetzt?</h4>
            <ul>
                <li>Ihre Bestellung wurde an die K√ºche weitergeleitet</li>
                <li>Sie k√∂nnen den Status hier verfolgen oder die Seite schlie√üen</li>
                <li>Bei Barzahlung: Bitte halten Sie den Betrag bereit</li>
                <li>Bei Problemen: Sprechen Sie unser Personal an</li>
            </ul>
        </div>

        <!-- Actions -->
        <div class="actions">
            <a href="index.html" class="btn btn-primary">
                <i class="fas fa-plus"></i> Neue Bestellung
            </a>
            <button class="btn btn-secondary" onclick="window.close()">
                <i class="fas fa-times"></i> Schlie√üen
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // FIREBASE CONFIGURATION
         const firebaseConfig = {
            apiKey: "AIzaSyBiVdp67AZmZnGpM8OlZXBGKJKhF4iDlsE",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.appspot.com",
            messagingSenderId: "168976461234",
            appId: "1:168976461234:web:abc123def456ghi789"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentOrderId = null;

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            if (window.ml) {
                window.ml.init();
            }
            
            setTimeout(() => {
                hideLoadingScreen();
                processOrderConfirmation();
            }, 1500);
        });

        // LOADING SCREEN VERSTECKEN
        function hideLoadingScreen() {
            const loader = document.getElementById('pizzaLoader');
            loader.classList.add('hidden');
        }

        // ORDER CONFIRMATION VERARBEITEN
        async function processOrderConfirmation() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                const orderId = urlParams.get('order_id');
                const paymentStatus = urlParams.get('payment');

                if (sessionId && orderId) {
                    // Stripe Payment Success
                    await handleStripeSuccess(sessionId, orderId);
                    document.getElementById('paymentInfo').style.display = 'block';
                } else if (paymentStatus === 'success' && orderId) {
                    // Cash Payment Success
                    await handleCashSuccess(orderId);
                } else {
                    // Fallback: Zeige generische Erfolgsseite
                    showGenericSuccess();
                }

                // Live-Updates f√ºr Bestellstatus starten
                if (currentOrderId) {
                    startStatusUpdates();
                }

            } catch (error) {
                console.error('Fehler beim Verarbeiten der Bestellbest√§tigung:', error);
                showErrorState();
            }
        }

        // STRIPE SUCCESS HANDLER
        async function handleStripeSuccess(sessionId, orderId) {
            try {
                // Tempor√§re Bestellung laden
                const tempOrderRef = await database.ref(`temp-orders/${orderId}`).once('value');
                const orderData = tempOrderRef.val();
                
                if (!orderData) {
                    throw new Error('Bestellung nicht gefunden');
                }

                // Payment Status update
                orderData.paymentStatus = 'completed';
                orderData.stripeSessionId = sessionId;
                orderData.confirmedAt = new Date().toISOString();

                // Zu aktiven Bestellungen verschieben
                const orderRef = await database.ref('orders').push(orderData);
                currentOrderId = orderRef.key;
                
                // Tempor√§re Bestellung l√∂schen
                await database.ref(`temp-orders/${orderId}`).remove();

                // UI aktualisieren
                displayOrderDetails(orderData, 'card');

            } catch (error) {
                console.error('Fehler beim Verarbeiten der Stripe-Zahlung:', error);
                throw error;
            }
        }

        // CASH SUCCESS HANDLER
        async function handleCashSuccess(orderId) {
            try {
                // Bestellung von Firebase laden
                const ordersRef = await database.ref('orders').once('value');
                const orders = ordersRef.val() || {};
                
                // Bestellung finden
                const orderEntry = Object.entries(orders).find(([_, order]) => order.id === orderId);
                
                if (orderEntry) {
                    currentOrderId = orderEntry[0];
                    displayOrderDetails(orderEntry[1], 'cash');
                } else {
                    throw new Error('Bestellung nicht gefunden');
                }

            } catch (error) {
                console.error('Fehler beim Laden der Barzahlungsbestellung:', error);
                throw error;
            }
        }

        // ORDER DETAILS ANZEIGEN
        function displayOrderDetails(orderData, paymentMethod) {
            // Order ID
            document.getElementById('orderNumber').textContent = orderData.id;
            
            // Order Time
            const orderTime = new Date(orderData.timestamp).toLocaleTimeString('de-CH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('orderTime').textContent = orderTime;
            
            // Wait Time
            document.getElementById('waitTime').textContent = `${orderData.waitTime} Min`;
            
            // Payment Method
            const paymentMethods = {
                'card': 'Kartenzahlung',
                'cash': 'Barzahlung',
                'twint': 'TWINT'
            };
            document.getElementById('paymentMethod').textContent = paymentMethods[paymentMethod] || paymentMethod;
            
            // Total Amount
            document.getElementById('totalAmount').textContent = `CHF ${orderData.total.toFixed(2)}`;
        }

        // LIVE STATUS UPDATES
        function startStatusUpdates() {
            if (!currentOrderId) return;
            
            database.ref(`orders/${currentOrderId}/status`).on('value', (snapshot) => {
                const status = snapshot.val();
                updateStatusTracker(status);
            });

            // Notifications listener
            database.ref(`notifications/${currentOrderId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                showNotification(notification.message, notification.playSound);
            });
        }

        // STATUS TRACKER UPDATE
        function updateStatusTracker(status) {
            const preparingIcon = document.getElementById('preparingIcon');
            const readyIcon = document.getElementById('readyIcon');

            // Reset all to pending
            preparingIcon.className = 'step-icon pending';
            readyIcon.className = 'step-icon pending';

            switch (status) {
                case 'zubereitung':
                    preparingIcon.className = 'step-icon active';
                    break;
                case 'fertig':
                    preparingIcon.className = 'step-icon active';
                    readyIcon.className = 'step-icon active';
                    break;
            }
        }

        // NOTIFICATION ANZEIGEN
        function showNotification(message, playSound = false) {
            // Simple notification - k√∂nnte erweitert werden
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <i class="fas fa-bell"></i>
                <span>${message}</span>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #22c55e, #16a34a);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;

            document.body.appendChild(notification);

            if (playSound) {
                playNotificationSound();
            }

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // NOTIFICATION SOUND
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
            } catch (error) {
                console.log('Sound nicht verf√ºgbar:', error);
            }
        }

        // GENERIC SUCCESS ANZEIGEN
        function showGenericSuccess() {
            document.getElementById('orderNumber').textContent = 'DEMO';
            document.getElementById('orderTime').textContent = new Date().toLocaleTimeString('de-CH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('waitTime').textContent = '5 Min';
            document.getElementById('paymentMethod').textContent = 'Demo-Modus';
            document.getElementById('totalAmount').textContent = 'CHF 0.00';
        }

        // ERROR STATE ANZEIGEN
        function showErrorState() {
            document.querySelector('.success-title').textContent = 'Fehler aufgetreten';
            document.querySelector('.success-subtitle').textContent = 'Es gab ein Problem beim Verarbeiten Ihrer Bestellung.';
            document.querySelector('.success-icon').innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            document.querySelector('.success-icon').style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        }

        console.log('Success Page geladen');
    </script>

    <style>
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</body>
</html>