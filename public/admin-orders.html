<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin.orders.title">Bestellverwaltung - Pizza&Pasta D'amico</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="css/admin-style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body data-page="admin">
    <!-- Language Selector -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="logo">üçï</span>
                <h2>D'amico Admin</h2>
            </div>
            
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="admin-dashboard.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span data-i18n="admin.nav.dashboard">Dashboard</span>
                </a>
                <a href="admin-orders.html" class="nav-link active">
                    <i class="fas fa-receipt"></i>
                    <span data-i18n="admin.nav.orders">Bestellungen</span>
                    <span class="notification-badge" id="orderCount" style="display: none;">0</span>
                </a>
                <a href="admin-products.html" class="nav-link">
                    <i class="fas fa-pizza-slice"></i>
                    <span data-i18n="admin.nav.products">Produkte</span>
                </a>
                <a href="#" onclick="logout()" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="admin.nav.logout">Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="admin-container">
        <!-- Header -->
        <div class="orders-header">
            <h1 data-i18n="admin.orders.title">Bestellverwaltung</h1>
            <p class="subtitle" data-i18n="admin.orders.subtitle">Verwalten Sie alle eingehenden Bestellungen</p>
        </div>

        <!-- Stats Bar -->
        <div class="stats-grid">
            <div class="stat-card compact">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label" data-i18n="admin.stats.ordersToday">Bestellungen heute</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-value" id="newOrders">0</div>
                <div class="stat-label" data-i18n="admin.orders.new">Neue Bestellungen</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-value" id="todayRevenue">CHF 0.00</div>
                <div class="stat-label" data-i18n="admin.stats.revenue">Heutiger Umsatz</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-value" id="avgPrepTime">0 Min</div>
                <div class="stat-label" data-i18n="admin.stats.avgPrepTime">√ò Zubereitungszeit</div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-section">
            <div class="filter-controls">
                <button class="filter-btn active" onclick="filterOrders('all')">
                    <i class="fas fa-list"></i>
                    <span data-i18n="admin.filter.all">Alle</span>
                </button>
                <button class="filter-btn" onclick="filterOrders('neu')">
                    <i class="fas fa-exclamation-circle"></i>
                    <span data-i18n="admin.filter.new">Neu</span>
                </button>
                <button class="filter-btn" onclick="filterOrders('zubereitung')">
                    <i class="fas fa-fire"></i>
                    <span data-i18n="admin.filter.preparing">In Zubereitung</span>
                </button>
                <button class="filter-btn" onclick="filterOrders('fertig')">
                    <i class="fas fa-check-circle"></i>
                    <span data-i18n="admin.filter.ready">Fertig</span>
                </button>
                
                <div class="sound-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundEnabled" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">
                            <i class="fas fa-volume-up"></i>
                            <span data-i18n="admin.sound">Ton</span>
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Orders Grid -->
        <div class="orders-grid" id="ordersContainer">
            <!-- Wird dynamisch gef√ºllt -->
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3 data-i18n="admin.noOrders">Keine Bestellungen</h3>
                <p data-i18n="admin.noOrdersDesc">Hier werden neue Bestellungen angezeigt</p>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalOrderId">Bestellung #123456</h3>
                <button class="modal-close" onclick="closeOrderDetails()">√ó</button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOrderDetails()">
                    <span data-i18n="admin.close">Schlie√üen</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-bell"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Globale Variablen
        let allOrders = [];
        let currentFilter = 'all';
        let soundEnabled = true;

        // Auth Check
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const loginTime = parseInt(localStorage.getItem('loginTime') || '0');
            const now = Date.now();
            
            if (!isLoggedIn || (now - loginTime) > (2 * 60 * 60 * 1000)) {
                localStorage.clear();
                window.location.href = 'admin.html';
                return false;
            }
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;

            // Load multilingual
            if (window.ml) {
                window.ml.init();
            }

            // Sound toggle
            document.getElementById('soundEnabled').addEventListener('change', (e) => {
                soundEnabled = e.target.checked;
            });

            // Load orders
            loadOrders();
        });

        // Load Orders
        function loadOrders() {
            const today = new Date().toDateString();
            
            database.ref('orders').on('value', (snapshot) => {
                allOrders = [];
                let todayCount = 0;
                let newCount = 0;
                let todayRevenue = 0;
                
                snapshot.forEach((child) => {
                    const order = { id: child.key, ...child.val() };
                    allOrders.push(order);
                    
                    const orderDate = new Date(order.timestamp).toDateString();
                    if (orderDate === today) {
                        todayCount++;
                        todayRevenue += order.total || 0;
                        
                        if (order.status === 'neu') {
                            newCount++;
                        }
                    }
                });
                
                // Update stats
                document.getElementById('totalOrders').textContent = todayCount;
                document.getElementById('newOrders').textContent = newCount;
                document.getElementById('todayRevenue').textContent = `CHF ${todayRevenue.toFixed(2)}`;
                
                // Sort by timestamp (newest first)
                allOrders.sort((a, b) => b.timestamp - a.timestamp);
                
                // Display orders
                displayOrders();
                
                // New order notification
                if (newCount > 0 && soundEnabled) {
                    playNotificationSound();
                }
            });
        }

        // Display Orders
        function displayOrders() {
            const container = document.getElementById('ordersContainer');
            const filteredOrders = currentFilter === 'all' 
                ? allOrders 
                : allOrders.filter(order => order.status === currentFilter);
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3 data-i18n="admin.noOrders">Keine Bestellungen</h3>
                        <p data-i18n="admin.noOrdersDesc">Hier werden neue Bestellungen angezeigt</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => `
                <div class="order-card status-${order.status || 'neu'}" onclick="showOrderDetails('${order.id}')">
                    <div class="order-header">
                        <div>
                            <div class="order-id">#${order.id.slice(-6)}</div>
                            <div class="order-time">
                                <i class="fas fa-clock"></i>
                                ${new Date(order.timestamp).toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                        <span class="order-status ${order.status || 'neu'}">
                            ${getStatusText(order.status || 'neu')}
                        </span>
                    </div>
                    
                    <div class="order-body">
                        <div class="customer-info">
                            <div class="customer-name">
                                <i class="fas fa-user"></i>
                                ${order.customerName || 'Gast'}
                            </div>
                            ${order.phone ? `
                                <div class="customer-phone">
                                    <i class="fas fa-phone"></i>
                                    ${order.phone}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="order-summary">
                            <div class="order-items-count">
                                <i class="fas fa-shopping-bag"></i>
                                ${order.items ? order.items.length : 0} Artikel
                            </div>
                            <div class="order-total">
                                CHF ${(order.total || 0).toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="order-wait-time">
                            <i class="fas fa-hourglass-half"></i>
                            Wartezeit: ${calculateWaitTime(order)} Min
                        </div>
                    </div>
                    
                    <div class="order-actions">
                        ${order.status === 'neu' ? `
                            <button class="btn btn-warning" onclick="updateStatus(event, '${order.id}', 'zubereitung')">
                                <i class="fas fa-fire"></i>
                                <span>Zubereiten</span>
                            </button>
                        ` : ''}
                        ${order.status === 'zubereitung' ? `
                            <button class="btn btn-success" onclick="updateStatus(event, '${order.id}', 'fertig')">
                                <i class="fas fa-check"></i>
                                <span>Fertig</span>
                            </button>
                        ` : ''}
                        ${order.status === 'fertig' ? `
                            <button class="btn btn-primary" onclick="notifyCustomer(event, '${order.id}')">
                                <i class="fas fa-bell"></i>
                                <span>Kunde rufen</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Filter Orders
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.filter-btn').classList.add('active');
            
            displayOrders();
        }

        // Update Order Status
        function updateStatus(event, orderId, newStatus) {
            event.stopPropagation();
            
            database.ref(`orders/${orderId}/status`).set(newStatus);
            
            // Send notification
            if (newStatus === 'zubereitung') {
                sendNotification(orderId, 'Ihre Bestellung wird jetzt zubereitet', false);
            } else if (newStatus === 'fertig') {
                sendNotification(orderId, 'Ihre Bestellung ist fertig! Bitte abholen.', true);
            }
            
            showNotification(`Status ge√§ndert: ${getStatusText(newStatus)}`);
        }

        // Send Customer Notification
        function sendNotification(orderId, message, playSound) {
            database.ref(`notifications/${orderId}`).push({
                message: message,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                playSound: playSound
            });
        }

        // Notify Customer (Stage 3)
        function notifyCustomer(event, orderId) {
            event.stopPropagation();
            
            sendNotification(orderId, 'üîî BITTE KOMMEN SIE ZUR ABHOLUNG! Ihre Bestellung wartet auf Sie.', true);
            showNotification('Kunde wurde benachrichtigt', 'success');
        }

        // Show Order Details
        function showOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            document.getElementById('modalOrderId').textContent = `Bestellung #${orderId.slice(-6)}`;
            
            const content = document.getElementById('orderDetailsContent');
            content.innerHTML = `
                <div class="order-detail-section">
                    <h4>Kundeninformationen</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">${order.customerName || 'Gast'}</span>
                        </div>
                        ${order.phone ? `
                            <div class="detail-item">
                                <span class="detail-label">Telefon:</span>
                                <span class="detail-value">${order.phone}</span>
                            </div>
                        ` : ''}
                        ${order.email ? `
                            <div class="detail-item">
                                <span class="detail-label">E-Mail:</span>
                                <span class="detail-value">${order.email}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="order-detail-section">
                    <h4>Bestelldetails</h4>
                    <div class="order-items-detail">
                        ${order.items.map(item => `
                            <div class="order-item-detail">
                                <div>
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-quantity">Anzahl: ${item.quantity}</div>
                                </div>
                                <div class="item-price">CHF ${(item.price * item.quantity).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-total-detail">
                        <span>Gesamtbetrag:</span>
                        <span>CHF ${order.total.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="order-detail-section">
                    <h4>Bestellinformationen</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Bestellzeit:</span>
                            <span class="detail-value">${new Date(order.timestamp).toLocaleString('de-CH')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                <span class="order-status ${order.status || 'neu'}">
                                    ${getStatusText(order.status || 'neu')}
                                </span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gesch√§tzte Wartezeit:</span>
                            <span class="detail-value">${calculateWaitTime(order)} Minuten</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('orderDetailsModal').classList.add('active');
        }

        function closeOrderDetails() {
            document.getElementById('orderDetailsModal').classList.remove('active');
        }

        // Utility Functions
        function calculateWaitTime(order) {
            const itemCount = order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            if (itemCount < 6) return 5;
            if (itemCount <= 11) return 10;
            return Math.min(15 + Math.floor((itemCount - 11) / 3) * 5, 30);
        }

        function getStatusText(status) {
            const texts = {
                'neu': 'Neu',
                'zubereitung': 'In Zubereitung',
                'fertig': 'Fertig'
            };
            return texts[status] || status;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBi+Bz/LXijMHFGS97OehTQ0MW6zn775mJAYwe8vz2oU8CRdmvOzpoVMQDViP7OukRhEKTaPf8sNuLAUme8v02Ag/BxNUr+3btp');
            audio.play();
        }

        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>