<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin.dashboard.title">Admin Dashboard - Pizza&Pasta D'amico</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="css/admin-style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body data-page="admin">
    <!-- Language Selector -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="logo">üçï</span>
                <h2>D'amico Admin</h2>
            </div>
            
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="admin-dashboard.html" class="nav-link active">
                    <i class="fas fa-chart-line"></i>
                    <span data-i18n="admin.nav.dashboard">Dashboard</span>
                </a>
                <a href="admin-orders.html" class="nav-link">
                    <i class="fas fa-receipt"></i>
                    <span data-i18n="admin.nav.orders">Bestellungen</span>
                    <span class="notification-badge" id="orderCount" style="display: none;">0</span>
                </a>
                <a href="admin-products.html" class="nav-link">
                    <i class="fas fa-pizza-slice"></i>
                    <span data-i18n="admin.nav.products">Produkte</span>
                </a>
                <a href="#" onclick="logout()" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="admin.nav.logout">Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="admin-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 data-i18n="admin.dashboard.title">Dashboard</h1>
            <p class="subtitle" data-i18n="admin.dashboard.subtitle">Willkommen im Admin-Bereich</p>
            <div class="header-date" id="currentDate"></div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="stat-label" data-i18n="admin.stats.ordersToday">Bestellungen heute</div>
                </div>
                <div class="stat-value" id="ordersToday">0</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12% vs. gestern</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                    <div class="stat-label" data-i18n="admin.stats.revenue">Heutiger Umsatz</div>
                </div>
                <div class="stat-value" id="revenueToday">CHF 0.00</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+8% vs. gestern</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-label" data-i18n="admin.stats.waitingOrders">Wartende Bestellungen</div>
                </div>
                <div class="stat-value" id="waitingOrders">0</div>
                <div class="stat-info">
                    <span>√ò Wartezeit: <strong id="avgWaitTime">0</strong> Min</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="stat-label" data-i18n="admin.stats.status">Truck Status</div>
                </div>
                <div class="stat-value">
                    <span class="status-badge active" id="truckStatus">Ge√∂ffnet</span>
                </div>
                <button class="btn btn-secondary" onclick="toggleTruckStatus()">
                    <i class="fas fa-power-off"></i>
                    <span data-i18n="admin.toggle">Status √§ndern</span>
                </button>
            </div>
        </div>

        <!-- Control Section -->
        <div class="control-section">
            <h2 class="section-title">
                <i class="fas fa-sliders-h"></i>
                <span data-i18n="admin.controls.title">Schnellsteuerung</span>
            </h2>

            <!-- Wait Time Control -->
            <div class="control-card">
                <h3 data-i18n="admin.waitTime.title">Wartezeit-Management</h3>
                <div class="wait-time-controls">
                    <button class="wait-time-btn" onclick="setWaitTime(5)">
                        <i class="fas fa-bolt"></i>
                        <span>Normal</span>
                        <small>5 Min</small>
                    </button>
                    <button class="wait-time-btn" onclick="setWaitTime(10)">
                        <i class="fas fa-fire"></i>
                        <span>Besch√§ftigt</span>
                        <small>10 Min</small>
                    </button>
                    <button class="wait-time-btn" onclick="setWaitTime(15)">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Sehr voll</span>
                        <small>15 Min</small>
                    </button>
                    <button class="wait-time-btn custom" onclick="showCustomWaitTime()">
                        <i class="fas fa-edit"></i>
                        <span>Custom</span>
                    </button>
                </div>
                <div class="current-wait-time">
                    <span>Aktuelle Wartezeit:</span>
                    <strong id="currentWaitTimeDisplay">5 Minuten</strong>
                </div>
            </div>

            <!-- Notification Control -->
            <div class="control-card">
                <h3 data-i18n="admin.notifications.title">Benachrichtigungen</h3>
                <div class="notification-controls">
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundEnabled" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="admin.notifications.sound">Ton bei neuen Bestellungen</span>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pushEnabled">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label" data-i18n="admin.notifications.push">Push-Benachrichtigungen</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Recent Orders Preview -->
        <div class="orders-preview-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list"></i>
                    <span data-i18n="admin.recentOrders">Aktuelle Bestellungen</span>
                </h2>
                <a href="admin-orders.html" class="btn btn-primary">
                    <span data-i18n="admin.viewAll">Alle anzeigen</span>
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            
            <div class="orders-preview-grid" id="recentOrdersPreview">
                <!-- Wird dynamisch gef√ºllt -->
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p data-i18n="admin.noOrders">Keine aktuellen Bestellungen</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Wait Time Modal -->
    <div class="modal" id="customWaitTimeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="admin.customWaitTime">Benutzerdefinierte Wartezeit</h3>
                <button class="modal-close" onclick="closeCustomWaitTime()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="admin.minutes">Minuten:</label>
                    <input type="number" id="customMinutes" min="1" max="60" value="20" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomWaitTime()">
                    <span data-i18n="admin.cancel">Abbrechen</span>
                </button>
                <button class="btn btn-primary" onclick="applyCustomWaitTime()">
                    <span data-i18n="admin.apply">Anwenden</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-check-circle"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Auth Check
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const loginTime = parseInt(localStorage.getItem('loginTime') || '0');
            const now = Date.now();
            
            if (!isLoggedIn || (now - loginTime) > (2 * 60 * 60 * 1000)) {
                localStorage.clear();
                window.location.href = 'admin.html';
                return false;
            }
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;

            // Load multilingual
            if (window.ml) {
                window.ml.init();
            }

            // Set current date
            const date = new Date();
            document.getElementById('currentDate').textContent = date.toLocaleDateString('de-CH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Load dashboard data
            loadDashboardData();
            
            // Real-time listeners
            listenToOrders();
            listenToSettings();
        });

        // Load Dashboard Data
        function loadDashboardData() {
            // Today's orders
            const today = new Date().toDateString();
            database.ref('orders').on('value', (snapshot) => {
                let todayOrders = 0;
                let todayRevenue = 0;
                let waitingOrders = 0;
                
                snapshot.forEach((child) => {
                    const order = child.val();
                    const orderDate = new Date(order.timestamp).toDateString();
                    
                    if (orderDate === today) {
                        todayOrders++;
                        todayRevenue += order.total || 0;
                        
                        if (order.status === 'neu' || order.status === 'zubereitung') {
                            waitingOrders++;
                        }
                    }
                });
                
                document.getElementById('ordersToday').textContent = todayOrders;
                document.getElementById('revenueToday').textContent = `CHF ${todayRevenue.toFixed(2)}`;
                document.getElementById('waitingOrders').textContent = waitingOrders;
            });
        }

        // Listen to orders for preview
        function listenToOrders() {
            database.ref('orders').orderByChild('timestamp').limitToLast(5).on('value', (snapshot) => {
                const container = document.getElementById('recentOrdersPreview');
                const orders = [];
                
                snapshot.forEach((child) => {
                    orders.push({ id: child.key, ...child.val() });
                });
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p data-i18n="admin.noOrders">Keine aktuellen Bestellungen</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = orders.reverse().map(order => {
                    const time = new Date(order.timestamp).toLocaleTimeString('de-CH', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Build items list
                    let itemsList = '';
                    if (order.items && order.items.length > 0) {
                        itemsList = order.items.map(item => `
                            <div class="order-item-line">
                                <span>
                                    <span class="order-item-quantity">${item.quantity}x</span>
                                    ${item.name}
                                </span>
                            </div>
                        `).join('');
                    }
                    
                    return `
                        <div class="order-preview" onclick="window.location.href='admin-orders.html'">
                            <div class="order-preview-header">
                                <span class="order-preview-id">#${order.id.slice(-6)}</span>
                                <span class="order-preview-time">${time}</span>
                            </div>
                            <div class="order-preview-customer">
                                <i class="fas fa-user"></i>
                                ${order.customerName || 'Gast'}
                            </div>
                            ${itemsList ? `
                                <div class="order-preview-items">
                                    ${itemsList}
                                </div>
                            ` : ''}
                            ${order.notes ? `
                                <div class="order-notes">
                                    <i class="fas fa-comment"></i>
                                    ${order.notes}
                                </div>
                            ` : ''}
                            <span class="order-preview-status status-${order.status || 'neu'}">
                                ${getStatusText(order.status || 'neu')}
                            </span>
                        </div>
                    `;
                }).join('');
            });
        }

        // Listen to settings
        function listenToSettings() {
            // Wait time
            database.ref('settings/waitTime').on('value', (snapshot) => {
                const waitTime = snapshot.val() || 5;
                document.getElementById('currentWaitTimeDisplay').textContent = `${waitTime} Minuten`;
                
                // Update button states
                document.querySelectorAll('.wait-time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            
            // Truck status
            database.ref('settings/isOpen').on('value', (snapshot) => {
                const isOpen = snapshot.val() !== false;
                const statusEl = document.getElementById('truckStatus');
                statusEl.textContent = isOpen ? 'Ge√∂ffnet' : 'Geschlossen';
                statusEl.className = isOpen ? 'status-badge active' : 'status-badge inactive';
            });
        }

        // Control Functions
        function setWaitTime(minutes) {
            database.ref('settings/waitTime').set(minutes);
            showNotification(`Wartezeit auf ${minutes} Minuten gesetzt`);
        }

        function toggleTruckStatus() {
            database.ref('settings/isOpen').once('value', (snapshot) => {
                const currentStatus = snapshot.val() !== false;
                database.ref('settings/isOpen').set(!currentStatus);
                showNotification(currentStatus ? 'Foodtruck geschlossen' : 'Foodtruck ge√∂ffnet');
            });
        }

        function showCustomWaitTime() {
            document.getElementById('customWaitTimeModal').classList.add('active');
        }

        function closeCustomWaitTime() {
            document.getElementById('customWaitTimeModal').classList.remove('active');
        }

        function applyCustomWaitTime() {
            const minutes = parseInt(document.getElementById('customMinutes').value);
            if (minutes > 0 && minutes <= 60) {
                setWaitTime(minutes);
                closeCustomWaitTime();
            }
        }

        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'admin.html';
        }

        function getStatusText(status) {
            const texts = {
                'neu': 'Neu',
                'zubereitung': 'In Zubereitung',
                'fertig': 'Fertig'
            };
            return texts[status] || status;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Sound notification for new orders
        let lastOrderCount = 0;
        database.ref('orders').on('value', (snapshot) => {
            const currentCount = snapshot.numChildren();
            if (currentCount > lastOrderCount && lastOrderCount > 0) {
                if (document.getElementById('soundEnabled').checked) {
                    playNotificationSound();
                }
                showNotification('Neue Bestellung eingegangen!', 'info');
            }
            lastOrderCount = currentCount;
        });

        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBi+Bz/LXijMHFGS97OehTQ0MW6zn775mJAYwe8vz2oU8CRdmvOzpoVMQDViP7OukRhEKTaPf8sNuLAUme8v02Ag/BxNUr+3btp');
            audio.play();
        }
    </script>
</body>
</html>