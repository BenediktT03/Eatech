<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eatech Admin Dashboard</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin-style.css">
    <link rel="stylesheet" href="css/voice-commands.css">
    <link rel="stylesheet" href="css/weather-integration.css">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Leaflet für Wetter-Karte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="nav-brand">
            <i class="fas fa-pizza-slice"></i>
            <span>Eatech Admin</span>
        </div>
        <div class="nav-links">
            <a href="admin-dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="admin-orders.html"><i class="fas fa-receipt"></i> Bestellungen</a>
            <a href="admin-products.html"><i class="fas fa-box"></i> Produkte</a>
            <a href="menu-designer.html"><i class="fas fa-palette"></i> Menu Designer</a>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="admin-container">
        <div class="dashboard-header">
            <h1>Dashboard Übersicht</h1>
            <div class="header-actions">
                <button class="btn-refresh" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Aktualisieren
                </button>
                <span class="last-update">Zuletzt aktualisiert: <span id="lastUpdate">-</span></span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-content">
                    <h3>Heutige Bestellungen</h3>
                    <p class="stat-value" id="todayOrders">0</p>
                    <span class="stat-change positive">+12% vs. gestern</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-euro-sign"></i>
                </div>
                <div class="stat-content">
                    <h3>Heutiger Umsatz</h3>
                    <p class="stat-value">CHF <span id="todayRevenue">0</span></p>
                    <span class="stat-change positive">+8% vs. gestern</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>Ø Wartezeit</h3>
                    <p class="stat-value"><span id="avgWaitTime">15</span> Min</p>
                    <span class="stat-change neutral">Gleichbleibend</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-content">
                    <h3>Aktive Bestellungen</h3>
                    <p class="stat-value" id="activeOrders">0</p>
                    <span class="stat-change">In Bearbeitung</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="dashboard-main">
            <!-- Left Column -->
            <div class="dashboard-left">
                <!-- Revenue Chart -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Umsatzentwicklung</h3>
                        <select id="chartPeriod" onchange="updateRevenueChart()">
                            <option value="week">Diese Woche</option>
                            <option value="month">Diesen Monat</option>
                            <option value="year">Dieses Jahr</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Popular Items -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-star"></i> Beliebte Produkte</h3>
                        <span class="badge">Top 5</span>
                    </div>
                    <div class="card-body">
                        <div id="popularItems" class="popular-items">
                            <!-- Wird dynamisch geladen -->
                        </div>
                    </div>
                </div>

                <!-- Weather Integration -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-cloud-sun"></i> Wetter & Wartezeit</h3>
                        <button class="btn-small" onclick="openWeatherSettings()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="weatherWidget" class="weather-widget">
                            <!-- Weather widget wird geladen -->
                        </div>
                        <div id="weatherMap" style="height: 200px; margin-top: 15px; border-radius: 8px;"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="dashboard-right">
                <!-- Real-time Orders -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-bell"></i> Aktuelle Bestellungen</h3>
                        <div class="live-indicator">
                            <span class="pulse"></span> Live
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="realtimeOrders" class="realtime-orders">
                            <!-- Wird dynamisch geladen -->
                        </div>
                    </div>
                </div>

                <!-- Voice Commands Status -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-microphone"></i> Eatech Voice</h3>
                        <div class="voice-toggle">
                            <label class="switch">
                                <input type="checkbox" id="voiceToggle" onchange="toggleVoiceCommands()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="voiceStatus" class="voice-status">
                            <div class="voice-indicator" id="voiceIndicator">
                                <i class="fas fa-microphone-slash"></i>
                                <span>Voice inaktiv</span>
                            </div>
                            <div class="voice-language">
                                <label>Sprache:</label>
                                <select id="voiceLanguage" onchange="updateVoiceLanguage()">
                                    <option value="de-DE">Deutsch</option>
                                    <option value="en-US">English</option>
                                    <option value="it-IT">Italiano</option>
                                    <option value="fr-FR">Français</option>
                                    <option value="es-ES">Español</option>
                                    <option value="tr-TR">Türkçe</option>
                                </select>
                            </div>
                            <div class="voice-commands-list">
                                <p><strong>Verfügbare Befehle:</strong></p>
                                <ul>
                                    <li>"Eatech, Bestellung [Nr] fertig"</li>
                                    <li>"Eatech, zeige Bestellungen"</li>
                                    <li>"Eatech, Wartezeit [Min] Minuten"</li>
                                    <li>"Eatech, Hilfe"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-bolt"></i> Schnellaktionen</h3>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions">
                            <button onclick="window.location.href='admin-products.html'" class="quick-action-btn">
                                <i class="fas fa-plus-circle"></i>
                                <span>Neues Produkt</span>
                            </button>
                            <button onclick="exportTodayOrders()" class="quick-action-btn">
                                <i class="fas fa-download"></i>
                                <span>Export Heute</span>
                            </button>
                            <button onclick="updateWaitTime()" class="quick-action-btn">
                                <i class="fas fa-clock"></i>
                                <span>Wartezeit ändern</span>
                            </button>
                            <button onclick="toggleShop()" class="quick-action-btn">
                                <i class="fas fa-store"></i>
                                <span>Shop Status</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-server"></i> System Status</h3>
                    </div>
                    <div class="card-body">
                        <div class="system-status">
                            <div class="status-item">
                                <span>Firebase</span>
                                <span class="status-indicator online"></span>
                            </div>
                            <div class="status-item">
                                <span>Stripe Payments</span>
                                <span class="status-indicator online"></span>
                            </div>
                            <div class="status-item">
                                <span>WhatsApp API</span>
                                <span class="status-indicator" id="whatsappStatus"></span>
                            </div>
                            <div class="status-item">
                                <span>Offline Sync</span>
                                <span class="status-indicator" id="offlineStatus"></span>
                            </div>
                            <div class="status-item">
                                <span>Weather API</span>
                                <span class="status-indicator" id="weatherApiStatus"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Command Feedback Component -->
    <div id="voiceFeedback" class="voice-feedback hidden">
        <div class="voice-animation">
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
        </div>
        <p class="voice-text">Höre zu...</p>
    </div>

    <!-- Weather Settings Modal -->
    <div id="weatherSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Wetter-Integration Einstellungen</h2>
                <button onclick="closeWeatherSettings()" class="close-btn">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <label>OpenWeatherMap API Key:</label>
                    <input type="text" id="weatherApiKey" placeholder="Dein API Key">
                    <small>Kostenlos auf openweathermap.org</small>
                </div>
                <div class="settings-section">
                    <label>Standort:</label>
                    <input type="text" id="weatherLocation" placeholder="z.B. Zürich">
                </div>
                <div class="settings-section">
                    <label>Wetter-Faktoren:</label>
                    <div class="factor-grid">
                        <div>
                            <label>Regen:</label>
                            <input type="range" id="rainFactor" min="0" max="100" value="50">
                            <span id="rainValue">50%</span>
                        </div>
                        <div>
                            <label>Temperatur:</label>
                            <input type="range" id="tempFactor" min="-50" max="50" value="0">
                            <span id="tempValue">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveWeatherSettings()" class="btn-primary">Speichern</button>
                <button onclick="closeWeatherSettings()" class="btn-secondary">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyDFBlgWE81iHnACVwOmaU0jL7FV0l_tRmU",
  authDomain: "eatech-foodtruck.firebaseapp.com",
  databaseURL: "https://eatech-foodtruck-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "eatech-foodtruck",
  storageBucket: "eatech-foodtruck.firebasestorage.app",
  messagingSenderId: "261222802445",
  appId: "1:261222802445:web:edde22580422fbced22144",
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Global variables
        let revenueChart;
        let voiceCommandsActive = false;
        
        // Check authentication
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                initializeDashboard();
            }
        });
        
        // Initialize Dashboard
        function initializeDashboard() {
            loadDashboardData();
            initializeRevenueChart();
            startRealtimeUpdates();
            checkSystemStatus();
            updateLastUpdate();
            
            // Initialize Voice Commands if enabled
            const voiceEnabled = localStorage.getItem('voiceCommandsEnabled') === 'true';
            if (voiceEnabled) {
                document.getElementById('voiceToggle').checked = true;
                toggleVoiceCommands();
            }
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                refreshDashboard();
            }, 30000);
        }
        
        // Load dashboard data
        function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0];
            
            // Load today's orders
            database.ref('orders').orderByChild('date').startAt(today).on('value', (snapshot) => {
                const orders = snapshot.val() || {};
                const todayOrdersArray = Object.values(orders).filter(order => 
                    order.date && order.date.startsWith(today)
                );
                
                // Update stats
                document.getElementById('todayOrders').textContent = todayOrdersArray.length;
                
                // Calculate revenue
                const revenue = todayOrdersArray.reduce((sum, order) => {
                    return sum + (order.total || 0);
                }, 0);
                document.getElementById('todayRevenue').textContent = revenue.toFixed(2);
                
                // Active orders
                const activeOrders = todayOrdersArray.filter(order => 
                    order.status === 'pending' || order.status === 'preparing'
                ).length;
                document.getElementById('activeOrders').textContent = activeOrders;
                
                // Update realtime orders
                updateRealtimeOrders(todayOrdersArray);
            });
            
            // Load average wait time
            database.ref('settings/estimatedWaitTime').on('value', (snapshot) => {
                const waitTime = snapshot.val() || 15;
                document.getElementById('avgWaitTime').textContent = waitTime;
            });
            
            // Load popular items
            loadPopularItems();
        }
        
        // Initialize Revenue Chart
        function initializeRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Umsatz (CHF)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 3,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
            
            updateRevenueChart();
        }
        
        // Update Revenue Chart
        function updateRevenueChart() {
            const period = document.getElementById('chartPeriod').value;
            const endDate = new Date();
            let startDate = new Date();
            let labels = [];
            
            switch(period) {
                case 'week':
                    startDate.setDate(endDate.getDate() - 7);
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString('de-CH', { weekday: 'short' }));
                    }
                    break;
                case 'month':
                    startDate.setMonth(endDate.getMonth() - 1);
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.getDate());
                    }
                    break;
                case 'year':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                    labels = months;
                    break;
            }
            
            // Simulate data for demo
            const data = labels.map(() => Math.floor(Math.random() * 1000) + 500);
            
            revenueChart.data.labels = labels;
            revenueChart.data.datasets[0].data = data;
            revenueChart.update();
        }
        
        // Load Popular Items
        function loadPopularItems() {
            database.ref('products').once('value', (snapshot) => {
                const products = snapshot.val() || {};
                const productsArray = Object.entries(products).map(([id, product]) => ({
                    id,
                    ...product,
                    orders: Math.floor(Math.random() * 50) + 10 // Simulated order count
                }));
                
                // Sort by orders and get top 5
                const topProducts = productsArray
                    .sort((a, b) => b.orders - a.orders)
                    .slice(0, 5);
                
                const container = document.getElementById('popularItems');
                container.innerHTML = topProducts.map((product, index) => `
                    <div class="popular-item">
                        <span class="rank">${index + 1}</span>
                        <div class="item-info">
                            <h4>${product.name}</h4>
                            <span class="item-orders">${product.orders} Bestellungen</span>
                        </div>
                        <span class="item-revenue">CHF ${(product.price * product.orders).toFixed(2)}</span>
                    </div>
                `).join('');
            });
        }
        
        // Update Realtime Orders
        function updateRealtimeOrders(orders) {
            const container = document.getElementById('realtimeOrders');
            const recentOrders = orders
                .filter(order => order.status === 'pending' || order.status === 'preparing')
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            if (recentOrders.length === 0) {
                container.innerHTML = '<p class="no-orders">Keine aktiven Bestellungen</p>';
                return;
            }
            
            container.innerHTML = recentOrders.map(order => `
                <div class="realtime-order-item status-${order.status}">
                    <div class="order-header">
                        <span class="order-number">#${order.orderNumber}</span>
                        <span class="order-time">${getTimeDiff(order.timestamp)}</span>
                    </div>
                    <div class="order-details">
                        <p class="customer-name">${order.customerName}</p>
                        <p class="order-items">${order.items.length} Artikel • CHF ${order.total.toFixed(2)}</p>
                    </div>
                    <div class="order-status">
                        <span class="status-badge ${order.status}">
                            ${order.status === 'pending' ? 'Neu' : 'In Bearbeitung'}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        // Get time difference
        function getTimeDiff(timestamp) {
            const diff = Date.now() - new Date(timestamp).getTime();
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Gerade eben';
            if (minutes === 1) return 'vor 1 Minute';
            return `vor ${minutes} Minuten`;
        }
        
        // Start realtime updates
        function startRealtimeUpdates() {
            // This would connect to Firebase realtime updates
            // For now, we'll update every 5 seconds
            setInterval(() => {
                updateLastUpdate();
            }, 5000);
        }
        
        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
        }
        
        // Check system status
        function checkSystemStatus() {
            // Check WhatsApp
            const whatsappEnabled = localStorage.getItem('whatsappEnabled') === 'true';
            document.getElementById('whatsappStatus').className = 
                `status-indicator ${whatsappEnabled ? 'online' : 'offline'}`;
            
            // Check Offline Status
            document.getElementById('offlineStatus').className = 
                `status-indicator ${navigator.onLine ? 'online' : 'offline'}`;
            
            // Check Weather API
            const weatherEnabled = localStorage.getItem('weatherEnabled') === 'true';
            document.getElementById('weatherApiStatus').className = 
                `status-indicator ${weatherEnabled ? 'online' : 'offline'}`;
        }
        
        // Refresh Dashboard
        function refreshDashboard() {
            loadDashboardData();
            updateRevenueChart();
            checkSystemStatus();
            updateLastUpdate();
            
            // Animate refresh button
            const btn = document.querySelector('.btn-refresh i');
            btn.classList.add('fa-spin');
            setTimeout(() => {
                btn.classList.remove('fa-spin');
            }, 1000);
        }
        
        // Export today's orders
        function exportTodayOrders() {
            alert('Export-Funktion wird implementiert...');
        }
        
        // Update wait time
        function updateWaitTime() {
            const newTime = prompt('Neue Wartezeit in Minuten:', '15');
            if (newTime && !isNaN(newTime)) {
                database.ref('settings/estimatedWaitTime').set(parseInt(newTime));
                alert(`Wartezeit auf ${newTime} Minuten aktualisiert`);
            }
        }
        
        // Toggle shop status
        function toggleShop() {
            database.ref('settings/shopOpen').once('value', (snapshot) => {
                const isOpen = snapshot.val() !== false;
                database.ref('settings/shopOpen').set(!isOpen);
                alert(`Shop ist jetzt ${!isOpen ? 'geöffnet' : 'geschlossen'}`);
            });
        }
        
        // Toggle Voice Commands
        function toggleVoiceCommands() {
            const enabled = document.getElementById('voiceToggle').checked;
            
            if (enabled) {
                // Start voice commands
                if (typeof initializeVoiceCommands === 'function') {
                    initializeVoiceCommands();
                    voiceCommandsActive = true;
                    updateVoiceStatus(true);
                    localStorage.setItem('voiceCommandsEnabled', 'true');
                }
            } else {
                // Stop voice commands
                if (typeof stopVoiceCommands === 'function') {
                    stopVoiceCommands();
                    voiceCommandsActive = false;
                    updateVoiceStatus(false);
                    localStorage.setItem('voiceCommandsEnabled', 'false');
                }
            }
        }
        
        // Update Voice Status Display
        function updateVoiceStatus(active) {
            const indicator = document.getElementById('voiceIndicator');
            if (active) {
                indicator.innerHTML = '<i class="fas fa-microphone"></i><span>Voice aktiv</span>';
                indicator.classList.add('active');
            } else {
                indicator.innerHTML = '<i class="fas fa-microphone-slash"></i><span>Voice inaktiv</span>';
                indicator.classList.remove('active');
            }
        }
        
        // Update Voice Language
        function updateVoiceLanguage() {
            const language = document.getElementById('voiceLanguage').value;
            if (typeof setVoiceLanguage === 'function') {
                setVoiceLanguage(language);
            }
        }
        
        // Weather Settings
        function openWeatherSettings() {
            document.getElementById('weatherSettingsModal').style.display = 'flex';
            
            // Load current settings
            const apiKey = localStorage.getItem('weatherApiKey') || '';
            const location = localStorage.getItem('weatherLocation') || 'Zürich';
            
            document.getElementById('weatherApiKey').value = apiKey;
            document.getElementById('weatherLocation').value = location;
        }
        
        function closeWeatherSettings() {
            document.getElementById('weatherSettingsModal').style.display = 'none';
        }
        
        function saveWeatherSettings() {
            const apiKey = document.getElementById('weatherApiKey').value;
            const location = document.getElementById('weatherLocation').value;
            
            localStorage.setItem('weatherApiKey', apiKey);
            localStorage.setItem('weatherLocation', location);
            localStorage.setItem('weatherEnabled', 'true');
            
            closeWeatherSettings();
            
            // Reload weather widget
            if (typeof initializeWeather === 'function') {
                initializeWeather();
            }
        }
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Wirklich ausloggen?')) {
                auth.signOut();
            }
        });
    </script>
    
    <!-- Additional Scripts -->
    <script src="js/voice-commands.js"></script>
    <script src="js/weather-integration.js"></script>
</body>
</html>