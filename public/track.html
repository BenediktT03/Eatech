<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung verfolgen - Pizza&Pasta D'amico</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="js/multilingual.js"></script>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div class="pizza-loader" id="pizzaLoader">
        <div class="spinning-pizza">üçï</div>
        <div class="loading-text">Pizza&Pasta D'amico</div>
        <div class="loading-subtext">Bestellverfolgung wird geladen...</div>
    </div>

    <!-- SPRACHAUSWAHL -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üîç Bestellung verfolgen</h1>
            <p class="subtitle">Verfolgen Sie den Status Ihrer Bestellung live</p>
            <div class="location-info">
                <i class="fas fa-truck"></i>
                <span>Pizza&Pasta D'amico ‚Ä¢ Live-Tracking</span>
            </div>
        </div>

        <div class="content">
            <div class="tracking-container">
                <!-- TRACKING INPUT -->
                <div class="tracking-input-section">
                    <div class="tracking-header">
                        <h2 style="color: #ffffff; margin-bottom: 10px;">
                            <i class="fas fa-search"></i> Bestellnummer eingeben
                        </h2>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                            Geben Sie Ihre 6-stellige Bestellnummer ein, um den aktuellen Status zu sehen
                        </p>
                    </div>

                    <form id="trackingForm" onsubmit="trackOrder(event)">
                        <div class="input-group">
                            <div class="form-group">
                                <label class="form-label" for="orderIdInput">
                                    <i class="fas fa-hashtag"></i> Bestellnummer
                                </label>
                                <input 
                                    type="text" 
                                    id="orderIdInput" 
                                    class="form-input"
                                    placeholder="z.B. 142357"
                                    maxlength="6"
                                    pattern="[0-9]{6}"
                                    required
                                    autocomplete="off"
                                >
                            </div>
                            <button type="submit" class="track-btn" id="trackBtn">
                                <i class="fas fa-search"></i>
                                <span>Verfolgen</span>
                            </button>
                        </div>
                    </form>

                    <!-- QUICK ACCESS -->
                    <div style="margin-top: 20px; text-align: center;">
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-bottom: 10px;">
                            Oder verwenden Sie einen Quick-Link:
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="trackOrderById('demo1')" style="padding: 8px 15px; font-size: 0.9rem;">
                                Demo #1
                            </button>
                            <button class="btn btn-secondary" onclick="trackOrderById('demo2')" style="padding: 8px 15px; font-size: 0.9rem;">
                                Demo #2
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ERROR MESSAGE -->
                <div class="tracking-error" id="trackingError">
                    <i class="fas fa-exclamation-triangle error-icon"></i>
                    <span id="errorMessage">Bestellung nicht gefunden. Pr√ºfen Sie Ihre Bestellnummer.</span>
                </div>

                <!-- TRACKING RESULT -->
                <div class="order-tracking-result" id="trackingResult">
                    <!-- ORDER HEADER -->
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 2rem; font-weight: 700; color: #3b82f6; margin-bottom: 10px;" id="trackedOrderId">
                            Bestellung #142357
                        </div>
                        <div style="color: rgba(255,255,255,0.7);" id="orderTimestamp">
                            Bestellt heute um 14:23 Uhr
                        </div>
                    </div>

                    <!-- LIVE STATUS TRACKER -->
                    <div class="status-tracker">
                        <h4 style="text-align: center; margin-bottom: 20px; color: #ffffff;">
                            <i class="fas fa-clock"></i> Live-Status
                        </h4>
                        <div class="status-steps" id="statusSteps">
                            <div class="status-step">
                                <div class="step-icon active" id="step-ordered">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">Bestellt</div>
                                <div class="step-line"></div>
                            </div>
                            <div class="status-step">
                                <div class="step-icon pending" id="step-preparing">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="step-label">Zubereitung</div>
                                <div class="step-line"></div>
                            </div>
                            <div class="status-step">
                                <div class="step-icon pending" id="step-ready">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="step-label">Fertig</div>
                            </div>
                        </div>

                        <!-- STATUS MESSAGE -->
                        <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(59,130,246,0.1); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2);">
                            <div style="color: #3b82f6; font-weight: 600; font-size: 1.1rem;" id="currentStatusMessage">
                                <i class="fas fa-info-circle"></i> Ihre Bestellung wurde angenommen und wartet auf Zubereitung
                            </div>
                        </div>
                    </div>

                    <!-- ORDER DETAILS -->
                    <div class="order-details-card">
                        <h4 style="color: #ffffff; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-list"></i> Bestelldetails
                        </h4>
                        
                        <div id="orderItemsList">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>

                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div class="detail-row">
                                <span class="detail-label">Gesch√§tzte Wartezeit:</span>
                                <span class="detail-value" id="estimatedWaitTime">8 Minuten</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Zahlungsmethode:</span>
                                <span class="detail-value" id="paymentMethodDisplay">Barzahlung</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Gesamtbetrag:</span>
                                <span class="detail-value amount" id="totalAmountDisplay">CHF 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- LIVE UPDATES -->
                    <div style="background: rgba(34,197,94,0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(34,197,94,0.2);">
                        <h4 style="color: #22c55e; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-broadcast-tower"></i> Live-Updates
                        </h4>
                        <div id="liveUpdatesList">
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; font-style: italic;">
                                Warten auf Updates...
                            </div>
                        </div>
                    </div>

                    <!-- ACTIONS -->
                    <div class="actions">
                        <a href="index.html" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Neue Bestellung
                        </a>
                        <button class="btn btn-secondary" onclick="refreshTracking()">
                            <i class="fas fa-sync-alt"></i> Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION POPUP -->
    <div class="notification-popup" id="notificationPopup">
        <span id="notificationMessage"></span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBiVdp67AZmZnGpM8OlZXBGKJKhF4iDlsE",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.appspot.com",
            messagingSenderId: "168976461234",
            appId: "1:168976461234:web:abc123def456ghi789"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentTrackedOrder = null;
        let updateListeners = [];

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Order Tracking wird geladen...');
            
            if (window.ml) {
                window.ml.init();
            }
            
            // URL Parameter pr√ºfen
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order');
            
            if (orderId) {
                document.getElementById('orderIdInput').value = orderId;
                setTimeout(() => trackOrderById(orderId), 1000);
            }
            
            setTimeout(hideLoadingScreen, 1500);
        });

        // LOADING SCREEN VERSTECKEN
        function hideLoadingScreen() {
            const loader = document.getElementById('pizzaLoader');
            loader.classList.add('hidden');
        }

        // TRACKING FORM HANDLER
        function trackOrder(event) {
            event.preventDefault();
            const orderId = document.getElementById('orderIdInput').value.trim();
            if (orderId) {
                trackOrderById(orderId);
            }
        }

        // ORDER BY ID VERFOLGEN
        async function trackOrderById(orderId) {
            const trackBtn = document.getElementById('trackBtn');
            const originalText = trackBtn.innerHTML;
            
            // Loading State
            trackBtn.disabled = true;
            trackBtn.innerHTML = '<div class="loading-spinner"></div> Suchen...';
            
            hideError();
            hideResult();

            try {
                // Zuerst in aktiven Bestellungen suchen
                const activeOrder = await findOrderInActive(orderId);
                if (activeOrder) {
                    displayOrderTracking(activeOrder.data, activeOrder.key);
                    startLiveUpdates(activeOrder.key);
                    return;
                }

                // Dann in archivierten Bestellungen suchen
                const archivedOrder = await findOrderInArchive(orderId);
                if (archivedOrder) {
                    displayArchivedOrder(archivedOrder.data);
                    return;
                }

                // Demo-Bestellungen f√ºr Testing
                if (orderId === 'demo1' || orderId === 'demo2') {
                    displayDemoOrder(orderId);
                    return;
                }

                // Nicht gefunden
                showError('Bestellung nicht gefunden. Pr√ºfen Sie Ihre Bestellnummer.');

            } catch (error) {
                console.error('Tracking-Fehler:', error);
                showError('Fehler beim Laden der Bestelldaten. Versuchen Sie es erneut.');
            } finally {
                trackBtn.disabled = false;
                trackBtn.innerHTML = originalText;
            }
        }

        // AKTIVE BESTELLUNG FINDEN
        async function findOrderInActive(orderId) {
            const snapshot = await database.ref('orders').once('value');
            const orders = snapshot.val() || {};
            
            for (const [key, order] of Object.entries(orders)) {
                if (order.id === orderId || key.slice(-6) === orderId) {
                    return { key, data: order };
                }
            }
            return null;
        }

        // ARCHIVIERTE BESTELLUNG FINDEN
        async function findOrderInArchive(orderId) {
            const snapshot = await database.ref('archive').once('value');
            const orders = snapshot.val() || {};
            
            for (const [key, order] of Object.entries(orders)) {
                if (order.id === orderId || key.slice(-6) === orderId) {
                    return { key, data: order };
                }
            }
            return null;
        }

        // ORDER TRACKING ANZEIGEN
        function displayOrderTracking(orderData, orderKey) {
            currentTrackedOrder = orderKey;
            
            // Order Header
            document.getElementById('trackedOrderId').textContent = `Bestellung #${orderData.id}`;
            
            const orderTime = new Date(orderData.timestamp);
            const timeStr = orderTime.toLocaleString('de-CH', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('orderTimestamp').textContent = `Bestellt am ${timeStr}`;

            // Status Tracker
            updateStatusDisplay(orderData.status || 'neu');

            // Order Items
            displayOrderItems(orderData.items || []);

            // Order Details
            document.getElementById('estimatedWaitTime').textContent = `${orderData.waitTime || 5} Minuten`;
            
            const paymentMethods = {
                'card': 'Kartenzahlung',
                'cash': 'Barzahlung',
                'twint': 'TWINT'
            };
            document.getElementById('paymentMethodDisplay').textContent = 
                paymentMethods[orderData.paymentMethod] || 'Barzahlung';
            
            document.getElementById('totalAmountDisplay').textContent = `CHF ${(orderData.total || 0).toFixed(2)}`;

            showResult();
        }

        // STATUS DISPLAY UPDATE
        function updateStatusDisplay(status) {
            const stepOrdered = document.getElementById('step-ordered');
            const stepPreparing = document.getElementById('step-preparing');
            const stepReady = document.getElementById('step-ready');
            const statusMessage = document.getElementById('currentStatusMessage');

            // Reset all steps
            stepOrdered.className = 'step-icon active';
            stepPreparing.className = 'step-icon pending';
            stepReady.className = 'step-icon pending';

            let message = '';
            let messageColor = '#3b82f6';

            switch (status) {
                case 'neu':
                    message = '<i class="fas fa-clock"></i> Ihre Bestellung wurde angenommen und wartet auf Zubereitung';
                    break;
                case 'zubereitung':
                    stepPreparing.className = 'step-icon active';
                    message = '<i class="fas fa-fire"></i> Ihre Bestellung wird gerade zubereitet';
                    messageColor = '#f59e0b';
                    break;
                case 'fertig':
                    stepPreparing.className = 'step-icon active';
                    stepReady.className = 'step-icon active';
                    message = '<i class="fas fa-bell"></i> Ihre Bestellung ist fertig zur Abholung!';
                    messageColor = '#22c55e';
                    break;
            }

            statusMessage.innerHTML = message;
            statusMessage.style.color = messageColor;
            statusMessage.parentElement.style.borderColor = messageColor.replace('#', 'rgba(') + ', 0.2)';
            statusMessage.parentElement.style.background = messageColor.replace('#', 'rgba(') + ', 0.1)';
        }

        // ORDER ITEMS ANZEIGEN
        function displayOrderItems(items) {
            const container = document.getElementById('orderItemsList');
            
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.6); font-style: italic;">Keine Artikel gefunden</div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="detail-row">
                    <span class="detail-label">${item.quantity || 1}x ${item.name}</span>
                    <span class="detail-value">CHF ${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                </div>
            `).join('');
        }

        // LIVE UPDATES STARTEN
        function startLiveUpdates(orderKey) {
            // Cleanup previous listeners
            updateListeners.forEach(listener => listener.off());
            updateListeners = [];

            // Status Listener
            const statusRef = database.ref(`orders/${orderKey}/status`);
            statusRef.on('value', (snapshot) => {
                const status = snapshot.val();
                if (status) {
                    updateStatusDisplay(status);
                    addLiveUpdate(`Status ge√§ndert: ${getStatusText(status)}`);
                }
            });
            updateListeners.push(statusRef);

            // Notifications Listener
            const notifRef = database.ref(`notifications/${orderKey}`);
            notifRef.on('child_added', (snapshot) => {
                const notification = snapshot.val();
                addLiveUpdate(notification.message, notification.playSound);
                
                if (notification.playSound) {
                    showNotification(notification.message, 'info', true);
                }
            });
            updateListeners.push(notifRef);
        }

        // LIVE UPDATE HINZUF√úGEN
        function addLiveUpdate(message, playSound = false) {
            const container = document.getElementById('liveUpdatesList');
            const timestamp = new Date().toLocaleTimeString('de-CH', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const updateElement = document.createElement('div');
            updateElement.style.cssText = `
                padding: 10px 0;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                animation: slideIn 0.3s ease;
            `;
            
            updateElement.innerHTML = `
                <span style="color: rgba(255,255,255,0.9);">
                    ${playSound ? '<i class="fas fa-volume-up" style="color: #f59e0b; margin-right: 8px;"></i>' : ''}
                    ${message}
                </span>
                <span style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">${timestamp}</span>
            `;

            // Erstes Update entfernen wenn es "Warten auf Updates..." war
            if (container.children.length === 1 && container.textContent.includes('Warten auf Updates')) {
                container.innerHTML = '';
            }

            container.insertBefore(updateElement, container.firstChild);

            // Maximal 5 Updates anzeigen
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }

        // STATUS TEXT √úBERSETZEN
        function getStatusText(status) {
            const statusTexts = {
                'neu': 'Neu',
                'zubereitung': 'In Zubereitung',
                'fertig': 'Fertig'
            };
            return statusTexts[status] || status;
        }

        // DEMO ORDER ANZEIGEN
        function displayDemoOrder(demoId) {
            const demoOrders = {
                'demo1': {
                    id: 'DEMO1',
                    timestamp: new Date(Date.now() - 300000).toISOString(), // 5 Min ago
                    status: 'zubereitung',
                    items: [
                        { name: 'Pizza Margherita', quantity: 1, price: 18.50 },
                        { name: 'Pasta Carbonara', quantity: 1, price: 19.00 }
                    ],
                    total: 37.50,
                    waitTime: 8,
                    paymentMethod: 'card'
                },
                'demo2': {
                    id: 'DEMO2',
                    timestamp: new Date(Date.now() - 900000).toISOString(), // 15 Min ago
                    status: 'fertig',
                    items: [
                        { name: 'Pizza Quattro Stagioni', quantity: 2, price: 22.50 }
                    ],
                    total: 45.00,
                    waitTime: 12,
                    paymentMethod: 'cash'
                }
            };

            const orderData = demoOrders[demoId];
            if (orderData) {
                displayOrderTracking(orderData, 'demo');
                
                // Demo Live Updates
                setTimeout(() => {
                    addLiveUpdate('Demo-Bestellung - Live-Updates simuliert');
                }, 1000);
                
                setTimeout(() => {
                    addLiveUpdate('K√ºche informiert - Zubereitung beginnt bald');
                }, 3000);
            }
        }

        // ARCHIVIERTE BESTELLUNG ANZEIGEN
        function displayArchivedOrder(orderData) {
            displayOrderTracking(orderData, null);
            
            // Spezielle Nachricht f√ºr archivierte Bestellungen
            document.getElementById('currentStatusMessage').innerHTML = 
                '<i class="fas fa-archive"></i> Diese Bestellung wurde bereits abgeholt und archiviert';
            document.getElementById('currentStatusMessage').style.color = '#6b7280';
            
            addLiveUpdate('Bestellung wurde erfolgreich abgeholt und archiviert');
        }

        // ERROR/RESULT HANDLING
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('trackingError').classList.add('show');
        }

        function hideError() {
            document.getElementById('trackingError').classList.remove('show');
        }

        function showResult() {
            document.getElementById('trackingResult').classList.add('show');
        }

        function hideResult() {
            document.getElementById('trackingResult').classList.remove('show');
        }

        // REFRESH TRACKING
        function refreshTracking() {
            if (currentTrackedOrder) {
                const orderId = document.getElementById('trackedOrderId').textContent.replace('Bestellung #', '');
                trackOrderById(orderId);
            }
        }

        // NOTIFICATION ANZEIGEN
        function showNotification(message, type = 'info', playSound = false) {
            const notification = document.getElementById('notificationPopup');
            const messageSpan = document.getElementById('notificationMessage');
            
            messageSpan.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i> 
                ${message}
            `;
            notification.className = `notification-popup ${type} show`;
            
            if (playSound) {
                playNotificationSound();
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // NOTIFICATION SOUND
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.log('Sound nicht verf√ºgbar:', error);
            }
        }

        // CLEANUP beim Verlassen der Seite
        window.addEventListener('beforeunload', () => {
            updateListeners.forEach(listener => listener.off());
        });

        console.log('Order Tracking Page geladen');
    </script>
</body>
</html>