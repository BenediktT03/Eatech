<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung verfolgen - Pizza&Pasta D'amico</title>
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body>
    <!-- Pizza Loader -->
    <div class="pizza-loader" id="pizzaLoader">
        <div class="spinning-pizza">üçï</div>
        <div class="loading-text">Pizza&Pasta D'amico</div>
        <div class="loading-subtext">Bestellverfolgung wird geladen...</div>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîç Bestellung verfolgen</h1>
            <p class="subtitle" data-i18n="track.subtitle">Verfolgen Sie den Status Ihrer Bestellung live</p>
            <div class="location-info">
                <i class="fas fa-truck"></i>
                <span>Pizza&Pasta D'amico ‚Ä¢ Live-Tracking</span>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Track Form -->
            <div class="track-container">
                <div class="track-form-section">
                    <h2 class="section-title">
                        <i class="fas fa-search"></i>
                        <span data-i18n="track.enterNumber">Bestellnummer eingeben</span>
                    </h2>
                    <p class="text-muted" data-i18n="track.instruction">
                        Geben Sie Ihre 6-stellige Bestellnummer ein, um den aktuellen Status zu sehen
                    </p>
                    
                    <form id="trackingForm" onsubmit="trackOrder(event)">
                        <div class="track-input-group">
                            <input 
                                type="text" 
                                id="orderIdInput" 
                                class="track-input"
                                placeholder="z.B. 142357"
                                maxlength="6"
                                pattern="[0-9A-Za-z]{6}"
                                required
                                autocomplete="off"
                            >
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                <span data-i18n="track.search">Suchen</span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Demo Links -->
                    <div class="demo-links">
                        <p class="text-muted" data-i18n="track.demo">Zum Testen:</p>
                        <div class="demo-buttons">
                            <button class="btn btn-secondary btn-small" onclick="trackDemoOrder('demo1')">
                                Demo #1
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="trackDemoOrder('demo2')">
                                Demo #2
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Result -->
            <div class="tracking-result" id="trackingResult" style="display: none;">
                <!-- Order Header -->
                <div class="order-tracking-header">
                    <div class="order-tracking-id" id="trackedOrderId">#000000</div>
                    <div class="order-tracking-time" id="orderTimestamp">-</div>
                </div>

                <!-- Status Tracker -->
                <div class="status-tracker">
                    <h3 class="section-title">
                        <i class="fas fa-clock"></i>
                        <span data-i18n="track.liveStatus">Live-Status</span>
                    </h3>
                    
                    <div class="status-steps">
                        <div class="status-step">
                            <div class="step-icon" id="step-ordered">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <span data-i18n="status.ordered">Bestellt</span>
                        </div>
                        
                        <div class="status-line"></div>
                        
                        <div class="status-step">
                            <div class="step-icon" id="step-preparing">
                                <i class="fas fa-fire"></i>
                            </div>
                            <span data-i18n="status.preparing">Zubereitung</span>
                        </div>
                        
                        <div class="status-line"></div>
                        
                        <div class="status-step">
                            <div class="step-icon" id="step-ready">
                                <i class="fas fa-bell"></i>
                            </div>
                            <span data-i18n="status.ready">Fertig</span>
                        </div>
                    </div>
                    
                    <div class="status-message" id="currentStatusMessage">
                        <i class="fas fa-info-circle"></i>
                        <span>Status wird geladen...</span>
                    </div>
                </div>

                <!-- Order Details -->
                <div class="order-details-card">
                    <h3 class="section-title">
                        <i class="fas fa-list"></i>
                        <span data-i18n="track.orderDetails">Bestelldetails</span>
                    </h3>
                    
                    <div id="orderItemsList" class="order-items-list">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                    
                    <div class="order-detail-info">
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="track.waitTime">Gesch√§tzte Wartezeit:</span>
                            <span class="detail-value" id="estimatedWaitTime">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="track.total">Gesamtbetrag:</span>
                            <span class="detail-value" id="orderTotal">CHF 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Live Updates -->
                <div class="updates-feed">
                    <h3 class="section-title">
                        <i class="fas fa-bell"></i>
                        <span data-i18n="track.liveUpdates">Live-Updates</span>
                    </h3>
                    <div id="liveUpdatesList" class="updates-list">
                        <div class="update-item">
                            <span class="update-message" data-i18n="track.waitingUpdates">Warten auf Updates...</span>
                            <span class="update-time">-</span>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="track-actions">
                    <button class="btn btn-secondary" onclick="refreshTracking()">
                        <i class="fas fa-sync"></i>
                        <span data-i18n="track.refresh">Aktualisieren</span>
                    </button>
                    <button class="btn btn-primary" onclick="trackNewOrder()">
                        <i class="fas fa-search"></i>
                        <span data-i18n="track.newSearch">Neue Suche</span>
                    </button>
                </div>
            </div>

            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <div class="status-emoji">üîç‚ùå</div>
                <h2 class="status-title" data-i18n="track.notFound">Bestellung nicht gefunden</h2>
                <p class="status-description" id="errorMessage">
                    Die eingegebene Bestellnummer konnte nicht gefunden werden.
                </p>
                <button class="btn btn-primary" onclick="trackNewOrder()">
                    <i class="fas fa-arrow-left"></i>
                    <span data-i18n="track.tryAgain">Erneut versuchen</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-bell"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
  apiKey: "AIzaSyDFBlgWE81iHnACVwOmaU0jL7FV0l_tRmU",
  authDomain: "eatech-foodtruck.firebaseapp.com",
  databaseURL: "https://eatech-foodtruck-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "eatech-foodtruck",
  storageBucket: "eatech-foodtruck.firebasestorage.app",
  messagingSenderId: "261222802445",
  appId: "1:261222802445:web:edde22580422fbced22144",
};

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Globale Variablen
        let currentTrackedOrder = null;
        let updateListeners = [];
        let notificationSound = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loader
            setTimeout(() => {
                document.getElementById('pizzaLoader').style.display = 'none';
            }, 1000);

            // Load multilingual
            if (window.ml) {
                window.ml.init();
            }

            // Initialize notification sound
            notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBi+Bz/LXijMHFGS97OehTQ0MW6zn775mJAYwe8vz2oU8CRdmvOzpoVMQDViP7OukRhEKTaPf8sNuLAUme8v02Ag/BxNUr+3btp');

            // Check URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order') || urlParams.get('orderId');
            
            if (orderId) {
                document.getElementById('orderIdInput').value = orderId.slice(-6);
                trackOrderById(orderId);
            }
        });

        // Track Order
        function trackOrder(event) {
            event.preventDefault();
            
            const orderId = document.getElementById('orderIdInput').value.trim();
            if (orderId.length !== 6) {
                showError('Bitte geben Sie eine 6-stellige Bestellnummer ein');
                return;
            }
            
            // Show loading
            showNotification('Suche Bestellung...', 'info');
            
            // Search in Firebase
            searchOrder(orderId);
        }

        // Search Order
        async function searchOrder(searchId) {
            try {
                // First check if it's a demo order
                if (searchId.toLowerCase().startsWith('demo')) {
                    displayDemoOrder(searchId);
                    return;
                }
                
                // Search in active orders
                const ordersSnapshot = await database.ref('orders').once('value');
                let foundOrder = null;
                let foundKey = null;
                
                ordersSnapshot.forEach((child) => {
                    const order = child.val();
                    const key = child.key;
                    
                    // Check if order ID matches (last 6 characters)
                    if (key.slice(-6).toLowerCase() === searchId.toLowerCase() ||
                        (order.id && order.id.slice(-6).toLowerCase() === searchId.toLowerCase())) {
                        foundOrder = order;
                        foundKey = key;
                    }
                });
                
                if (foundOrder) {
                    displayOrder(foundKey, foundOrder);
                } else {
                    // Search in archived orders
                    const archiveSnapshot = await database.ref('archive').once('value');
                    
                    archiveSnapshot.forEach((child) => {
                        const order = child.val();
                        const key = child.key;
                        
                        if (key.slice(-6).toLowerCase() === searchId.toLowerCase()) {
                            foundOrder = order;
                            foundKey = key;
                        }
                    });
                    
                    if (foundOrder) {
                        displayOrder(foundKey, foundOrder, true);
                    } else {
                        showError('Bestellung nicht gefunden. Bitte √ºberpr√ºfen Sie die Bestellnummer.');
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.');
            }
        }

        // Track Order by ID
        function trackOrderById(orderId) {
            database.ref(`orders/${orderId}`).once('value', (snapshot) => {
                const order = snapshot.val();
                
                if (order) {
                    displayOrder(orderId, order);
                } else {
                    // Check archive
                    database.ref(`archive/${orderId}`).once('value', (archiveSnapshot) => {
                        const archivedOrder = archiveSnapshot.val();
                        if (archivedOrder) {
                            displayOrder(orderId, archivedOrder, true);
                        } else {
                            showError('Bestellung nicht gefunden');
                        }
                    });
                }
            });
        }

        // Display Order
        function displayOrder(orderKey, order, isArchived = false) {
            currentTrackedOrder = { key: orderKey, data: order };
            
            // Update UI
            document.getElementById('trackedOrderId').textContent = `Bestellung #${orderKey.slice(-6).toUpperCase()}`;
            
            const orderDate = new Date(order.timestamp);
            const timeString = orderDate.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
            const dateString = orderDate.toLocaleDateString('de-CH');
            const isToday = orderDate.toDateString() === new Date().toDateString();
            
            document.getElementById('orderTimestamp').textContent = 
                isToday ? `Heute um ${timeString} Uhr` : `${dateString} um ${timeString} Uhr`;
            
            // Display items
            if (order.items && order.items.length > 0) {
                const itemsList = document.getElementById('orderItemsList');
                itemsList.innerHTML = order.items.map(item => `
                    <div class="order-item">
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-quantity">${item.quantity}x CHF ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="item-total">CHF ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `).join('');
            }
            
            // Wait time
            document.getElementById('estimatedWaitTime').textContent = `${order.waitTime || 10} Minuten`;
            
            // Total
            document.getElementById('orderTotal').textContent = `CHF ${(order.total || 0).toFixed(2)}`;
            
            // Update status
            updateStatusDisplay(order.status || 'neu');
            
            // Show result
            document.querySelector('.track-container').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('trackingResult').style.display = 'block';
            
            // Start live updates if not archived
            if (!isArchived) {
                startLiveUpdates(orderKey);
            } else {
                document.getElementById('currentStatusMessage').innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Diese Bestellung wurde bereits abgeholt und archiviert</span>
                `;
                addLiveUpdate('Bestellung wurde erfolgreich abgeholt und archiviert');
            }
        }

        // Update Status Display
        function updateStatusDisplay(status) {
            const steps = {
                'neu': 1,
                'zubereitung': 2,
                'fertig': 3
            };
            
            const currentStep = steps[status] || 1;
            
            // Update step icons
            const stepOrdered = document.getElementById('step-ordered');
            const stepPreparing = document.getElementById('step-preparing');
            const stepReady = document.getElementById('step-ready');
            
            // Reset classes
            stepOrdered.className = 'step-icon';
            stepPreparing.className = 'step-icon';
            stepReady.className = 'step-icon';
            
            // Set completed steps
            if (currentStep >= 1) stepOrdered.className = 'step-icon completed';
            if (currentStep >= 2) stepPreparing.className = 'step-icon completed';
            if (currentStep >= 3) stepReady.className = 'step-icon completed';
            
            // Set active step
            if (currentStep === 1 && status === 'neu') stepOrdered.className = 'step-icon active';
            if (currentStep === 2) stepPreparing.className = 'step-icon active';
            if (currentStep === 3) stepReady.className = 'step-icon active';
            
            // Update status message
            const messages = {
                'neu': 'Ihre Bestellung wurde angenommen und wartet auf Zubereitung',
                'zubereitung': 'Ihre Bestellung wird gerade frisch zubereitet',
                'fertig': 'üéâ Ihre Bestellung ist fertig! Bitte kommen Sie zur Abholung.'
            };
            
            document.getElementById('currentStatusMessage').innerHTML = `
                <i class="fas fa-${status === 'fertig' ? 'check-circle' : status === 'zubereitung' ? 'fire' : 'info-circle'}"></i>
                <span>${messages[status] || 'Status wird aktualisiert...'}</span>
            `;
        }

        // Start Live Updates
        function startLiveUpdates(orderKey) {
            // Clean up previous listeners
            updateListeners.forEach(listener => listener.off());
            updateListeners = [];
            
            // Status listener
            const statusRef = database.ref(`orders/${orderKey}/status`);
            statusRef.on('value', (snapshot) => {
                const status = snapshot.val();
                if (status) {
                    updateStatusDisplay(status);
                    addLiveUpdate(`Status ge√§ndert: ${getStatusText(status)}`);
                }
            });
            updateListeners.push(statusRef);
            
            // Notifications listener
            const notifRef = database.ref(`notifications/${orderKey}`);
            notifRef.on('child_added', (snapshot) => {
                const notification = snapshot.val();
                if (notification) {
                    addLiveUpdate(notification.message, notification.playSound);
                    
                    if (notification.playSound && notificationSound) {
                        notificationSound.play().catch(e => console.log('Sound play failed'));
                    }
                    
                    showNotification(notification.message, 'info');
                }
            });
            updateListeners.push(notifRef);
        }

        // Add Live Update
        function addLiveUpdate(message, isImportant = false) {
            const container = document.getElementById('liveUpdatesList');
            const timestamp = new Date().toLocaleTimeString('de-CH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Remove initial waiting message
            if (container.children.length === 1 && container.textContent.includes('Warten auf Updates')) {
                container.innerHTML = '';
            }
            
            const updateDiv = document.createElement('div');
            updateDiv.className = 'update-item';
            updateDiv.innerHTML = `
                <span class="update-message ${isImportant ? 'important' : ''}">
                    ${isImportant ? '<i class="fas fa-bell"></i> ' : ''}
                    ${message}
                </span>
                <span class="update-time">${timestamp}</span>
            `;
            
            container.insertBefore(updateDiv, container.firstChild);
            
            // Keep only last 10 updates
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Demo Orders
        function trackDemoOrder(demoId) {
            document.getElementById('orderIdInput').value = demoId;
            displayDemoOrder(demoId);
        }

        function displayDemoOrder(demoId) {
            const demoOrders = {
                'demo1': {
                    id: 'DEMO1',
                    timestamp: new Date(Date.now() - 300000).toISOString(), // 5 min ago
                    status: 'zubereitung',
                    items: [
                        { name: 'Pizza Margherita', quantity: 1, price: 18.50 },
                        { name: 'Pasta Carbonara', quantity: 1, price: 19.50 },
                        { name: 'Coca Cola', quantity: 2, price: 4.50 }
                    ],
                    total: 47.00,
                    waitTime: 10,
                    customerName: 'Demo Kunde'
                },
                'demo2': {
                    id: 'DEMO2',
                    timestamp: new Date(Date.now() - 900000).toISOString(), // 15 min ago
                    status: 'fertig',
                    items: [
                        { name: 'Pizza Salami', quantity: 2, price: 21.00 },
                        { name: 'Tiramisu', quantity: 2, price: 8.50 }
                    ],
                    total: 59.00,
                    waitTime: 15,
                    customerName: 'Test Bestellung'
                }
            };
            
            const order = demoOrders[demoId.toLowerCase()];
            if (order) {
                displayOrder(demoId.toUpperCase(), order);
                
                // Add some demo updates
                setTimeout(() => {
                    addLiveUpdate('Demo-Modus: Dies ist eine Test-Bestellung');
                }, 500);
                
                if (order.status === 'fertig') {
                    setTimeout(() => {
                        addLiveUpdate('üîî Ihre Bestellung ist fertig! Bitte abholen.', true);
                    }, 1000);
                }
            } else {
                showError('Demo-Bestellung nicht gefunden');
            }
        }

        // Utility Functions
        function getStatusText(status) {
            const texts = {
                'neu': 'Neu',
                'zubereitung': 'In Zubereitung',
                'fertig': 'Fertig'
            };
            return texts[status] || status;
        }

        function refreshTracking() {
            if (currentTrackedOrder) {
                // Re-fetch current order
                trackOrderById(currentTrackedOrder.key);
                showNotification('Aktualisiert', 'success');
            }
        }

        function trackNewOrder() {
            // Reset UI
            document.getElementById('trackingForm').reset();
            document.querySelector('.track-container').style.display = 'block';
            document.getElementById('trackingResult').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            
            // Clean up listeners
            updateListeners.forEach(listener => listener.off());
            updateListeners = [];
            
            // Focus input
            document.getElementById('orderIdInput').focus();
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.querySelector('.track-container').style.display = 'none';
            document.getElementById('trackingResult').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            // Update icon based on type
            const icon = type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'info' ? 'fa-info-circle' : 'fa-check-circle';
            
            notification.querySelector('i').className = `fas ${icon}`;
            messageEl.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>

    <style>
        /* Track page specific styles */
        .track-input-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .track-input {
            flex: 1;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .demo-links {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        .demo-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .tracking-result {
            animation: fadeIn 0.5s ease;
        }

        .order-tracking-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-lg);
        }

        .order-tracking-id {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .order-tracking-time {
            color: var(--text-secondary);
        }

        .updates-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .update-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            animation: slideIn 0.3s ease;
        }

        .update-item:last-child {
            border-bottom: none;
        }

        .update-message {
            flex: 1;
            color: var(--text-primary);
        }

        .update-message.important {
            color: var(--accent-yellow);
            font-weight: 600;
        }

        .update-time {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 15px;
        }

        .track-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            .track-input-group {
                flex-direction: column;
            }
            
            .track-actions {
                flex-direction: column;
            }
            
            .track-actions .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html>