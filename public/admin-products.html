<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin.products.title">Produktverwaltung - Pizza&Pasta D'amico</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="css/admin-style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body data-page="admin">
    <!-- Language Selector -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="logo">üçï</span>
                <h2>D'amico Admin</h2>
            </div>
            
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="admin-dashboard.html" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span data-i18n="admin.nav.dashboard">Dashboard</span>
                </a>
                <a href="admin-orders.html" class="nav-link">
                    <i class="fas fa-receipt"></i>
                    <span data-i18n="admin.nav.orders">Bestellungen</span>
                </a>
                <a href="admin-products.html" class="nav-link active">
                    <i class="fas fa-pizza-slice"></i>
                    <span data-i18n="admin.nav.products">Produkte</span>
                </a>
                <a href="#" onclick="logout()" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="admin.nav.logout">Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="admin-container">
        <!-- Header -->
        <div class="products-header">
            <h1 data-i18n="admin.products.title">Produktverwaltung</h1>
            <p class="subtitle" data-i18n="admin.products.subtitle">Verwalten Sie Ihr Men√º und Ihre Produkte</p>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Produkt suchen..." class="form-input" onkeyup="searchProducts()">
            </div>
            <button class="btn btn-primary" onclick="showAddProduct()">
                <i class="fas fa-plus"></i>
                <span data-i18n="admin.products.add">Neues Produkt</span>
            </button>
        </div>

        <!-- Category Tabs -->
        <div class="category-management">
            <div class="category-tabs">
                <button class="category-tab active" onclick="filterByCategory('all')">
                    <i class="fas fa-th"></i>
                    <span data-i18n="admin.products.all">Alle</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('pizza')">
                    <i class="fas fa-pizza-slice"></i>
                    <span data-i18n="category.pizza">Pizza</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('pasta')">
                    <i class="fas fa-utensils"></i>
                    <span data-i18n="category.pasta">Pasta</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('drinks')">
                    <i class="fas fa-glass-martini"></i>
                    <span data-i18n="category.drinks">Getr√§nke</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('desserts')">
                    <i class="fas fa-ice-cream"></i>
                    <span data-i18n="category.desserts">Desserts</span>
                </button>
            </div>
            <button class="add-category-btn" onclick="showAddCategory()">
                <i class="fas fa-plus"></i>
                <span>Kategorie</span>
            </button>
        </div>

        <!-- Products Grid -->
        <div class="products-grid" id="productsContainer">
            <!-- Wird dynamisch gef√ºllt -->
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3 data-i18n="admin.products.noProducts">Keine Produkte</h3>
                <p data-i18n="admin.products.noProductsDesc">F√ºgen Sie Ihr erstes Produkt hinzu</p>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" data-i18n="admin.products.addTitle">Neues Produkt hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeProductModal()">√ó</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="modal-body">
                    <input type="hidden" id="productId">
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="admin.products.name">Name</label>
                        <input type="text" id="productName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="admin.products.description">Beschreibung</label>
                        <textarea id="productDescription" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="admin.products.price">Preis (CHF)</label>
                            <input type="number" id="productPrice" class="form-input" step="0.50" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" data-i18n="admin.products.category">Kategorie</label>
                            <select id="productCategory" class="form-select" required>
                                <option value="pizza" data-i18n="category.pizza">Pizza</option>
                                <option value="pasta" data-i18n="category.pasta">Pasta</option>
                                <option value="drinks" data-i18n="category.drinks">Getr√§nke</option>
                                <option value="desserts" data-i18n="category.desserts">Desserts</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="admin.products.emoji">Emoji</label>
                        <input type="text" id="productEmoji" class="form-input" placeholder="z.B. üçï" maxlength="2">
                    </div>
                    
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="productAvailable" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label" data-i18n="admin.products.available">Verf√ºgbar</span>
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">
                        <span data-i18n="admin.cancel">Abbrechen</span>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        <span data-i18n="admin.save">Speichern</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 data-i18n="admin.products.deleteTitle">Produkt l√∂schen?</h3>
                <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p data-i18n="admin.products.deleteConfirm">M√∂chten Sie dieses Produkt wirklich l√∂schen?</p>
                <p class="text-muted" id="deleteProductName"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">
                    <span data-i18n="admin.cancel">Abbrechen</span>
                </button>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i>
                    <span data-i18n="admin.delete">L√∂schen</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 data-i18n="admin.category.title">Neue Kategorie</h3>
                <button class="modal-close" onclick="closeCategoryModal()">√ó</button>
            </div>
            <form id="categoryForm" onsubmit="saveCategory(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="categoryName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Icon/Emoji</label>
                        <input type="text" id="categoryIcon" class="form-input" placeholder="z.B. üçï">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">
                        <span data-i18n="admin.cancel">Abbrechen</span>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        <span data-i18n="admin.save">Speichern</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-check-circle"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
  apiKey: "AIzaSyDFBlgWE81iHnACVwOmaU0jL7FV0l_tRmU",
  authDomain: "eatech-foodtruck.firebaseapp.com",
  databaseURL: "https://eatech-foodtruck-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "eatech-foodtruck",
  storageBucket: "eatech-foodtruck.firebasestorage.app",
  messagingSenderId: "261222802445",
  appId: "1:261222802445:web:edde22580422fbced22144",
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Globale Variablen
        let allProducts = [];
        let currentCategory = 'all';
        let productToDelete = null;

        // Auth Check
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const loginTime = parseInt(localStorage.getItem('loginTime') || '0');
            const now = Date.now();
            
            if (!isLoggedIn || (now - loginTime) > (2 * 60 * 60 * 1000)) {
                localStorage.clear();
                window.location.href = 'admin.html';
                return false;
            }
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;

            // Load multilingual
            if (window.ml) {
                window.ml.init();
            }

            // Load products
            loadProducts();
        });

        // Load Products
        function loadProducts() {
            database.ref('products').on('value', (snapshot) => {
                allProducts = [];
                
                snapshot.forEach((child) => {
                    allProducts.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                displayProducts();
            });
        }

        // Display Products
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredProducts = allProducts;
            
            // Filter by category
            if (currentCategory !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === currentCategory);
            }
            
            // Filter by search
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3 data-i18n="admin.products.noProducts">Keine Produkte</h3>
                        <p data-i18n="admin.products.noProductsDesc">F√ºgen Sie Ihr erstes Produkt hinzu</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredProducts.map(product => `
                <div class="product-admin-card ${!product.available ? 'unavailable' : ''}">
                    <div class="product-emoji">${product.emoji || 'üçΩÔ∏è'}</div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        ${product.description ? `<p class="product-description">${product.description}</p>` : ''}
                        <div class="product-meta">
                            <span class="product-price">CHF ${product.price.toFixed(2)}</span>
                            <span class="product-category">${getCategoryName(product.category)}</span>
                        </div>
                        ${!product.available ? '<span class="unavailable-badge">Nicht verf√ºgbar</span>' : ''}
                    </div>
                    <div class="product-actions">
                        <button class="btn-icon edit" onclick="editProduct('${product.id}')" title="Bearbeiten">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon visibility" onclick="toggleAvailability('${product.id}', ${product.available})" title="Verf√ºgbarkeit">
                            <i class="fas fa-${product.available ? 'eye' : 'eye-slash'}"></i>
                        </button>
                        <button class="btn-icon danger" onclick="deleteProduct('${product.id}')" title="L√∂schen">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Category Filter
        function filterByCategory(category) {
            currentCategory = category;
            
            // Update tab states
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.category-tab').classList.add('active');
            
            displayProducts();
        }

        // Search Products
        function searchProducts() {
            displayProducts();
        }

        // Show Add Product Modal
        function showAddProduct() {
            document.getElementById('modalTitle').setAttribute('data-i18n', 'admin.products.addTitle');
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModal').classList.add('active');
        }

        // Edit Product
        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('modalTitle').setAttribute('data-i18n', 'admin.products.editTitle');
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productEmoji').value = product.emoji || '';
            document.getElementById('productAvailable').checked = product.available !== false;
            
            document.getElementById('productModal').classList.add('active');
        }

        // Save Product
        function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                emoji: document.getElementById('productEmoji').value || 'üçΩÔ∏è',
                available: document.getElementById('productAvailable').checked
            };
            
            if (productId) {
                // Update existing product
                database.ref(`products/${productId}`).update(productData);
                showNotification('Produkt aktualisiert');
            } else {
                // Add new product
                database.ref('products').push(productData);
                showNotification('Produkt hinzugef√ºgt');
            }
            
            closeProductModal();
        }

        // Toggle Availability
        function toggleAvailability(productId, currentStatus) {
            database.ref(`products/${productId}/available`).set(!currentStatus);
            showNotification(currentStatus ? 'Produkt deaktiviert' : 'Produkt aktiviert');
        }

        // Delete Product
        function deleteProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            productToDelete = productId;
            document.getElementById('deleteProductName').textContent = product.name;
            document.getElementById('deleteModal').classList.add('active');
        }

        function confirmDelete() {
            if (productToDelete) {
                database.ref(`products/${productToDelete}`).remove();
                showNotification('Produkt gel√∂scht');
                closeDeleteModal();
            }
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            productToDelete = null;
        }

        // Close Product Modal
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        // Utility Functions
        function getCategoryName(category) {
            const names = {
                'pizza': 'Pizza',
                'pasta': 'Pasta',
                'drinks': 'Getr√§nke',
                'desserts': 'Desserts'
            };
            return names[category] || category;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        function showAddCategory() {
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('categoryForm').reset();
        }

        function saveCategory(event) {
            event.preventDefault();
            // Hier w√ºrde die Kategorie-Speicherlogik kommen
            showNotification('Kategorie-Verwaltung noch in Entwicklung', 'info');
            closeCategoryModal();
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>