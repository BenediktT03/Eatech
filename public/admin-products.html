<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin.products.title">Produktverwaltung - Pizza&Pasta D'amico</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body>
    <!-- Sprachauswahl -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <!-- Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="logo">üçï</span>
                <h2>D'amico Admin</h2>
            </div>
            
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
            
            <div class="nav-links" id="navLinks">
                <a href="admin-dashboard.html" class="nav-link" id="nav-dashboard">
                    <span class="nav-icon">üìä</span>
                    <span data-i18n="admin.nav.dashboard">Dashboard</span>
                </a>
                <a href="admin-orders.html" class="nav-link" id="nav-orders">
                    <span class="nav-icon">üìã</span>
                    <span data-i18n="admin.nav.orders">Bestellungen</span>
                    <span class="notification-badge" id="orderCount" style="display: none;">0</span>
                </a>
                <a href="admin-products.html" class="nav-link active" id="nav-products">
                    <span class="nav-icon">üçΩÔ∏è</span>
                    <span data-i18n="admin.nav.products">Produkte</span>
                </a>
            </div>
            
            <div class="user-menu">
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar">A</div>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <a href="#" onclick="logout()">
                        <span class="nav-icon">üö™</span> 
                        <span data-i18n="admin.nav.logout">Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="products-container">
        <div class="page-header">
            <h1 data-i18n="admin.products.title">Produktverwaltung</h1>
            <button class="add-product-btn" onclick="openProductModal()">
                <span>‚ûï</span> <span data-i18n="admin.products.addNew">Neues Produkt</span>
            </button>
        </div>

        <!-- Kategorie Manager -->
        <div class="category-manager">
            <h3 data-i18n="admin.products.categories">Kategorien verwalten</h3>
            <div class="category-list" id="categoryList">
                <!-- Wird dynamisch geladen -->
            </div>
            <div class="add-category">
                <input type="text" id="newCategoryInput" class="form-input" 
                       placeholder="Neue Kategorie..." data-i18n-placeholder="admin.products.newCategory">
                <button onclick="addCategory()" class="btn btn-primary">
                    <span data-i18n="add">Hinzuf√ºgen</span>
                </button>
            </div>
        </div>

        <!-- Produkte nach Kategorie -->
        <div id="productsContainer">
            <!-- Wird dynamisch geladen -->
        </div>
    </div>

    <!-- Produkt Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" data-i18n="admin.products.newProduct">Neues Produkt</h2>
                <button class="close-modal" onclick="closeProductModal()">√ó</button>
            </div>
            
            <form id="productForm">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label class="form-label" data-i18n="admin.products.name">Produktname</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="admin.products.category">Kategorie</label>
                    <select id="productCategory" class="form-select" required>
                        <!-- Wird dynamisch geladen -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="admin.products.price">Preis (CHF)</label>
                    <input type="number" id="productPrice" class="form-input" step="0.50" min="0" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="admin.products.description">Beschreibung</label>
                    <textarea id="productDescription" class="form-textarea" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-i18n="admin.products.image">Produktbild</label>
                    <div class="image-upload">
                        <img id="productImagePreview" src="https://via.placeholder.com/200" 
                             alt="Vorschau" class="image-preview">
                        <div class="upload-actions">
                            <input type="file" id="productImageFile" accept="image/*" style="display: none;">
                            <button type="button" onclick="document.getElementById('productImageFile').click()" 
                                    class="btn btn-secondary">
                                <span data-i18n="admin.products.uploadImage">Bild hochladen</span>
                            </button>
                            <button type="button" onclick="generateAIImage()" class="btn btn-secondary">
                                <span data-i18n="admin.products.generateAI">KI-Bild generieren</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productAvailable" checked>
                        <span data-i18n="admin.products.available">Produkt ist verf√ºgbar</span>
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" data-i18n="save">Speichern</button>
                    <button type="button" onclick="closeProductModal()" class="btn btn-secondary" data-i18n="cancel">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyBiVdp67AZmZnGpM8OlZXBGKJKhF4iDlsE",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.appspot.com",
            messagingSenderId: "168976461234",
            appId: "1:168976461234:web:abc123def456ghi789"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // WICHTIG: Auth Check - Redirect zu admin.html wenn nicht eingeloggt
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'admin.html';
            } else {
                initializeProducts();
            }
        });

        // Placeholder Image
        const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiPktlaW4gQmlsZDwvdGV4dD48L3N2Zz4=';

        // Globale Variablen
        let categories = [];
        let products = {};
        let currentEditingId = null;

        // Initialisierung
        function initializeProducts() {
            loadCategories();
            loadProducts();
            setupEventListeners();
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
            document.getElementById('productImageFile').addEventListener('change', handleImageUpload);
            
            // Badge aktualisieren
            db.ref('orders').on('value', (snapshot) => {
                const orders = snapshot.val() || {};
                const newOrders = Object.values(orders).filter(o => o.status === 'neu').length;
                const badge = document.getElementById('orderCount');
                if (newOrders > 0) {
                    badge.textContent = newOrders;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            });
        }

        // Kategorien laden
        function loadCategories() {
            db.ref('categories').on('value', (snapshot) => {
                categories = Object.values(snapshot.val() || {});
                renderCategories();
                updateCategorySelect();
            });
        }

        // Produkte laden
        function loadProducts() {
            db.ref('products').on('value', (snapshot) => {
                products = snapshot.val() || {};
                renderProducts();
            });
        }

        // Kategorien rendern
        function renderCategories() {
            const container = document.getElementById('categoryList');
            container.innerHTML = categories.map(cat => `
                <div class="category-item">
                    ${cat}
                    <span class="category-delete" onclick="deleteCategory('${cat}')">√ó</span>
                </div>
            `).join('');
        }

        // Kategorie hinzuf√ºgen
        async function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const category = input.value.trim().toLowerCase();
            
            if (!category) return;
            
            if (categories.includes(category)) {
                showNotification(window.ml.t('admin.products.categoryExists'), 'error');
                return;
            }
            
            try {
                await db.ref('categories').push(category);
                input.value = '';
                showNotification(window.ml.t('admin.products.categoryAdded'), 'success');
            } catch (error) {
                console.error('Error adding category:', error);
                showNotification(window.ml.t('error.generic'), 'error');
            }
        }

        // Kategorie l√∂schen
        async function deleteCategory(category) {
            if (!confirm(window.ml.t('admin.products.deleteCategory').replace('{name}', category))) {
                return;
            }
            
            try {
                // Finde und l√∂sche die Kategorie
                const snapshot = await db.ref('categories').once('value');
                const categories = snapshot.val() || {};
                
                for (const [key, value] of Object.entries(categories)) {
                    if (value === category) {
                        await db.ref(`categories/${key}`).remove();
                        break;
                    }
                }
                
                showNotification(window.ml.t('admin.products.categoryDeleted'), 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                showNotification(window.ml.t('error.generic'), 'error');
            }
        }

        // Produkte rendern
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            
            // Gruppiere Produkte nach Kategorie
            const productsByCategory = {};
            Object.entries(products).forEach(([id, product]) => {
                if (!productsByCategory[product.category]) {
                    productsByCategory[product.category] = [];
                }
                productsByCategory[product.category].push({ id, ...product });
            });
            
            container.innerHTML = Object.entries(productsByCategory).map(([category, categoryProducts]) => `
                <div class="products-section">
                    <h2 class="category-title">${category}</h2>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th data-i18n="admin.products.image">Bild</th>
                                <th data-i18n="admin.products.name">Name</th>
                                <th data-i18n="admin.products.description">Beschreibung</th>
                                <th data-i18n="admin.products.price">Preis</th>
                                <th data-i18n="admin.products.status">Status</th>
                                <th data-i18n="admin.products.actions">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${categoryProducts.map(product => `
                                <tr>
                                    <td>
                                        <img src="${product.image || PLACEHOLDER_IMAGE}" 
                                             alt="${product.name}" 
                                             class="product-image-small">
                                    </td>
                                    <td>${product.name}</td>
                                    <td>${product.description || '-'}</td>
                                    <td>CHF ${product.price.toFixed(2)}</td>
                                    <td>
                                        <span class="status-badge ${product.available ? 'available' : 'unavailable'}">
                                            ${product.available ? '‚úì Verf√ºgbar' : '‚úó Nicht verf√ºgbar'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="product-actions">
                                            <button onclick="editProduct('${product.id}')" class="edit-btn">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteProduct('${product.id}')" class="delete-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `).join('');
            
            // Leerer Zustand
            if (Object.keys(productsByCategory).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-pizza-slice"></i>
                        <h3 data-i18n="admin.products.noProducts">Keine Produkte vorhanden</h3>
                        <p data-i18n="admin.products.addFirstProduct">F√ºgen Sie Ihr erstes Produkt hinzu</p>
                    </div>
                `;
            }
        }

        // Kategorie-Select aktualisieren
        function updateCategorySelect() {
            const select = document.getElementById('productCategory');
            select.innerHTML = categories.map(cat => `
                <option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
            `).join('');
        }

        // Produkt Modal √∂ffnen
        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('productForm');
            
            currentEditingId = productId;
            
            if (productId) {
                modalTitle.setAttribute('data-i18n', 'admin.products.editProduct');
                modalTitle.textContent = window.ml.t('admin.products.editProduct');
                
                const product = products[productId];
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productAvailable').checked = product.available;
                document.getElementById('productImagePreview').src = product.image || PLACEHOLDER_IMAGE;
            } else {
                modalTitle.setAttribute('data-i18n', 'admin.products.newProduct');
                modalTitle.textContent = window.ml.t('admin.products.newProduct');
                form.reset();
                document.getElementById('productImagePreview').src = PLACEHOLDER_IMAGE;
            }
            
            modal.classList.add('show');
        }

        // Produkt Modal schlie√üen
        function closeProductModal() {
            const modal = document.getElementById('productModal');
            modal.classList.remove('show');
            currentEditingId = null;
        }

        // Produkt bearbeiten
        function editProduct(productId) {
            openProductModal(productId);
        }

        // Produkt l√∂schen
        async function deleteProduct(productId) {
            if (!confirm(window.ml.t('admin.products.confirmDelete'))) {
                return;
            }
            
            try {
                await db.ref(`products/${productId}`).remove();
                showNotification(window.ml.t('admin.products.deleted'), 'success');
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification(window.ml.t('error.generic'), 'error');
            }
        }

        // Produkt Form Submit
        async function handleProductSubmit(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                available: document.getElementById('productAvailable').checked,
                image: document.getElementById('productImagePreview').src !== PLACEHOLDER_IMAGE 
                       ? document.getElementById('productImagePreview').src 
                       : null
            };
            
            try {
                showLoading(true);
                
                if (currentEditingId) {
                    await db.ref(`products/${currentEditingId}`).update(productData);
                    showNotification(window.ml.t('admin.products.updated'), 'success');
                } else {
                    await db.ref('products').push(productData);
                    showNotification(window.ml.t('admin.products.created'), 'success');
                }
                
                closeProductModal();
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification(window.ml.t('error.generic'), 'error');
            } finally {
                showLoading(false);
            }
        }

        // Bild Upload Handler
        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification(window.ml.t('admin.products.invalidImage'), 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                // Bild zu Firebase Storage hochladen
                const timestamp = Date.now();
                const fileName = `products/${timestamp}_${file.name}`;
                const storageRef = storage.ref(fileName);
                const snapshot = await storageRef.put(file);
                const downloadUrl = await snapshot.ref.getDownloadURL();
                
                document.getElementById('productImagePreview').src = downloadUrl;
                showNotification(window.ml.t('admin.products.imageUploaded'), 'success');
            } catch (error) {
                console.error('Error uploading image:', error);
                showNotification(window.ml.t('error.imageUpload'), 'error');
            } finally {
                showLoading(false);
            }
        }

        // KI-Bild generieren (Placeholder)
        function generateAIImage() {
            showNotification(window.ml.t('admin.feature.comingSoon'), 'info');
        }

        // Loading anzeigen/verbergen
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Benachrichtigung anzeigen
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Navigation
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('show');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
            
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.user-menu')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        function logout() {
            if (confirm(window.ml.t('admin.logout.confirm'))) {
                auth.signOut().then(() => {
                    window.location.href = 'admin.html';
                });
            }
        }

        // Modal schlie√üen bei Klick au√üerhalb
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target == modal) {
                closeProductModal();
            }
        }
    </script>
</body>
</html>