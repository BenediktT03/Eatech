<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza&Pasta D'amico - Authentische italienische K√ºche</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="js/multilingual.js"></script>
</head>
<body>
    <!-- PIZZA LOADING SCREEN -->
    <div class="pizza-loader" id="pizzaLoader">
        <div class="spinning-pizza">üçï</div>
        <div class="loading-text" data-i18n="loading.title">Pizza&Pasta D'amico</div>
        <div class="loading-subtext" data-i18n="loading.subtitle">Lade k√∂stliche Speisekarte...</div>
    </div>

    <!-- WARTEZEIT BANNER -->
    <div class="wait-time-banner" id="waitTimeBanner" style="display: none;">
        <i class="fas fa-clock"></i> 
        <span id="waitTimeText" data-i18n="waittime.current">Aktuelle Wartezeit: 5 Minuten</span>
    </div>

    <!-- SPRACHAUSWAHL -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1 data-i18n="site.title">üçï Pizza&Pasta D'amico</h1>
            <p class="subtitle" data-i18n="site.subtitle">Authentische italienische K√ºche</p>
            <div class="location-info" id="locationInfo">
                <i class="fas fa-truck"></i>
                <span data-i18n="site.location">Foodtruck ‚Ä¢ Abholung</span>
            </div>
            <div class="status-badges">
                <div class="status-badge" id="statusBadge">
                    <i class="fas fa-circle"></i> 
                    <span id="statusText" data-i18n="loading">Wird geladen...</span>
                </div>
                <div class="status-badge" style="background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.3); color: #60a5fa;">
                    <i class="fas fa-clock"></i> 
                    <span id="prepTime" data-i18n="waittime.estimate">5 Min</span>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- STATUS WENN GESCHLOSSEN -->
            <div class="status-message" id="closedMessage" style="display: none;">
                <div class="status-emoji">üò¥</div>
                <h2 class="status-title" data-i18n="status.closed.title">Foodtruck geschlossen</h2>
                <p class="status-description" data-i18n="status.closed.desc">Wir sind gerade geschlossen. Schauen Sie sp√§ter wieder vorbei!</p>
                <button class="status-retry-btn" onclick="location.reload()" data-i18n="status.retry">Erneut versuchen</button>
            </div>

            <!-- STATUS KEINE PRODUKTE -->
            <div class="status-message" id="noProductsMessage" style="display: none;">
                <div class="status-emoji">üì¶</div>
                <h2 class="status-title" data-i18n="status.noproducts.title">Keine Produkte verf√ºgbar</h2>
                <p class="status-description" data-i18n="status.noproducts.desc">Momentan sind keine Gerichte verf√ºgbar.</p>
                <button class="status-retry-btn" onclick="location.reload()" data-i18n="status.retry">Erneut versuchen</button>
            </div>

            <!-- STATUS VERBINDUNGSFEHLER -->
            <div class="status-message" id="errorMessage" style="display: none;">
                <div class="status-emoji">‚ö†Ô∏è</div>
                <h2 class="status-title" data-i18n="status.error.title">Verbindungsfehler</h2>
                <p class="status-description" data-i18n="status.error.desc">Es gab ein Problem beim Laden. Bitte versuchen Sie es erneut.</p>
                <button class="status-retry-btn" onclick="location.reload()" data-i18n="status.retry">Erneut versuchen</button>
            </div>

            <!-- PRODUKTE SECTION -->
            <div class="section" id="productsSection">
                <h2 class="section-title" data-i18n="products.title">Unsere Spezialit√§ten</h2>
                <div class="products-grid" id="productsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p data-i18n="loading">Speisekarte wird geladen...</p>
                    </div>
                </div>
            </div>

            <!-- WARENKORB -->
            <div class="cart-section" id="cartSection">
                <div class="cart-header">
                    <i class="fas fa-shopping-cart"></i>
                    <h3 data-i18n="cart.title">Ihre Bestellung</h3>
                </div>
                <div id="cartItems"></div>
                <div class="cart-totals">
                    <div class="cart-total-row final">
                        <span data-i18n="cart.total">Gesamttotal</span>
                        <span id="totalPrice">CHF 0.00</span>
                    </div>
                </div>
            </div>

            <!-- NOTIZEN -->
            <div class="note-section" style="display: none;" id="noteSection">
                <h3>
                    <i class="fas fa-comment"></i> 
                    <span data-i18n="order.note">Besondere W√ºnsche</span>
                </h3>
                <textarea 
                    id="orderNote" 
                    class="note-input" 
                    data-i18n="order.note.placeholder"
                    placeholder="z.B. extra scharf, ohne Zwiebeln..."></textarea>
            </div>

            <!-- BESTELL-BUTTON -->
            <button id="orderBtn" class="order-btn" disabled onclick="placeOrder()">
                <i class="fas fa-shopping-cart"></i> 
                <span data-i18n="cart.empty">Produkt ausw√§hlen</span>
            </button>
        </div>
    </div>

    <!-- NOTIFICATION POPUP -->
    <div class="notification-popup" id="notificationPopup">
        <span id="notificationMessage"></span>
    </div>

    <!-- ORDER TRACKING POPUP -->
    <div class="order-tracking-popup" id="orderTrackingPopup" style="display: none;">
        <div class="popup-content">
            <h3 data-i18n="order.track.title">M√∂chten Sie Ihre Bestellung verfolgen?</h3>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="openTrackingPage()">
                    <i class="fas fa-search"></i> Verfolgen
                </button>
                <button class="btn btn-secondary" onclick="closeTrackingPopup()">
                    <i class="fas fa-times"></i> Schlie√üen
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <!-- Stripe SDK -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // FIREBASE CONFIGURATION
         const firebaseConfig = {
            apiKey: "AIzaSyBiVdp67AZmZnGpM8OlZXBGKJKhF4iDlsE",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.appspot.com",
            messagingSenderId: "168976461234",
            appId: "1:168976461234:web:abc123def456ghi789"
        };

        // STRIPE CONFIGURATION
        const stripe = Stripe('pk_test_51234567890abcdef'); // TEST KEY - In Production ersetzen!

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // GLOBAL VARIABLES
        let availableProducts = {};
        let cart = {};
        let currentWaitTime = 5;
        let restaurantOpen = false;
        let currentOrderId = null;

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Pizza&Pasta D\'amico wird geladen...');
            
            // Sprache initialisieren
            if (window.ml) {
                window.ml.init();
            }
            
            // Core-Funktionen laden
            loadRestaurantStatus();
            loadWaitTime();
            loadProducts();
            setupNotificationListener();
            
            // Loading-Screen nach 2 Sekunden verstecken
            setTimeout(hideLoadingScreen, 2000);
        });

        // LOADING SCREEN VERSTECKEN
        function hideLoadingScreen() {
            const loader = document.getElementById('pizzaLoader');
            loader.classList.add('hidden');
        }

        // RESTAURANT STATUS LADEN
        function loadRestaurantStatus() {
            database.ref('settings/restaurantOpen').on('value', (snapshot) => {
                restaurantOpen = snapshot.val() || false;
                updateRestaurantStatus();
            });
        }

        // RESTAURANT STATUS UPDATE
        function updateRestaurantStatus() {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            const closedMessage = document.getElementById('closedMessage');
            const productsSection = document.getElementById('productsSection');

            if (restaurantOpen) {
                statusBadge.style.background = 'rgba(34, 197, 94, 0.2)';
                statusBadge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                statusBadge.style.color = '#22c55e';
                statusText.textContent = window.t ? window.t('status.open') : 'Ge√∂ffnet';
                
                closedMessage.style.display = 'none';
                productsSection.style.display = 'block';
            } else {
                statusBadge.style.background = 'rgba(239, 68, 68, 0.2)';
                statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusBadge.style.color = '#ef4444';
                statusText.textContent = window.t ? window.t('status.closed') : 'Geschlossen';
                
                closedMessage.style.display = 'block';
                productsSection.style.display = 'none';
            }
        }

        // WARTEZEIT LADEN
        function loadWaitTime() {
            database.ref('settings/waitTime').on('value', (snapshot) => {
                currentWaitTime = snapshot.val() || 5;
                updateWaitTimeDisplay();
            });
        }

        // WARTEZEIT ANZEIGE UPDATE
        function updateWaitTimeDisplay() {
            const prepTime = document.getElementById('prepTime');
            const waitTimeBanner = document.getElementById('waitTimeBanner');
            const waitTimeText = document.getElementById('waitTimeText');

            prepTime.textContent = `${currentWaitTime} Min`;
            
            if (currentWaitTime > 5) {
                waitTimeBanner.style.display = 'flex';
                waitTimeText.textContent = window.t 
                    ? window.t('waittime.current', { time: currentWaitTime })
                    : `Aktuelle Wartezeit: ${currentWaitTime} Minuten`;
            } else {
                waitTimeBanner.style.display = 'none';
            }
        }

        // PRODUKTE LADEN
        function loadProducts() {
            database.ref('products').on('value', (snapshot) => {
                availableProducts = snapshot.val() || {};
                renderProducts();
            }, (error) => {
                console.error('Fehler beim Laden der Produkte:', error);
                showErrorMessage();
            });
        }

        // PRODUKTE RENDERN
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const products = Object.entries(availableProducts).filter(([_, product]) => product.available);
            
            if (products.length === 0) {
                showNoProductsMessage();
                return;
            }
            
            grid.innerHTML = products.map(([id, product]) => `
                <div class="product-card" data-product="${id}">
                    <div class="product-info">
                        <div class="product-emoji">${getProductEmoji(product.category)}</div>
                        <div class="product-details">
                            <h3>${product.name}</h3>
                            <div class="product-price">CHF ${product.price.toFixed(2)}</div>
                        </div>
                    </div>
                    <p class="product-description">${product.description}</p>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="updateCart('${id}', -1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity-display" id="qty-${id}">0</span>
                        <button class="quantity-btn" onclick="updateCart('${id}', 1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            hideStatusMessages();
        }

        // PRODUKT EMOJI ERMITTELN
        function getProductEmoji(category) {
            const emojis = {
                'pizza': 'üçï',
                'pasta': 'üçù',
                'salad': 'ü•ó',
                'drink': 'ü•§',
                'dessert': 'üç∞'
            };
            return emojis[category] || 'üçΩÔ∏è';
        }

        // STATUS NACHRICHTEN VERBERGEN
        function hideStatusMessages() {
            document.getElementById('closedMessage').style.display = 'none';
            document.getElementById('noProductsMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('productsSection').style.display = 'block';
        }

        // KEINE PRODUKTE NACHRICHT
        function showNoProductsMessage() {
            document.getElementById('noProductsMessage').style.display = 'block';
            document.getElementById('productsSection').style.display = 'none';
        }

        // FEHLER NACHRICHT
        function showErrorMessage() {
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('productsSection').style.display = 'none';
        }

        // WARENKORB AKTUALISIEREN
        function updateCart(productId, change) {
            if (!availableProducts[productId]) return;
            
            if (!cart[productId]) cart[productId] = 0;
            cart[productId] = Math.max(0, cart[productId] + change);
            
            if (cart[productId] === 0) {
                delete cart[productId];
            }
            
            document.getElementById(`qty-${productId}`).textContent = cart[productId] || 0;
            updateCartDisplay();
        }

        // WARENKORB-ANZEIGE AKTUALISIEREN
        function updateCartDisplay() {
            const cartSection = document.getElementById('cartSection');
            const cartItems = document.getElementById('cartItems');
            const totalPrice = document.getElementById('totalPrice');
            const orderBtn = document.getElementById('orderBtn');
            const noteSection = document.getElementById('noteSection');
            
            const items = Object.entries(cart);
            
            if (items.length === 0) {
                cartSection.classList.remove('visible');
                noteSection.style.display = 'none';
                orderBtn.disabled = true;
                orderBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> ${window.t ? window.t('cart.empty') : 'Produkt ausw√§hlen'}`;
                return;
            }
            
            cartSection.classList.add('visible');
            noteSection.style.display = 'block';
            
            let total = 0;
            cartItems.innerHTML = items.map(([productId, quantity]) => {
                const product = availableProducts[productId];
                const itemTotal = product.price * quantity;
                total += itemTotal;
                
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${product.name}</div>
                            <div class="cart-item-details">${quantity}x CHF ${product.price.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-price">CHF ${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
            
            totalPrice.textContent = `CHF ${total.toFixed(2)}`;
            
            const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
            orderBtn.disabled = false;
            
            const orderText = window.t 
                ? window.t('order.button', { count: itemCount })
                : `Bestellen (${itemCount} Artikel)`;
            orderBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> ${orderText}`;
        }

        // BESTELLUNG AUFGEBEN
        async function placeOrder() {
            if (Object.keys(cart).length === 0) return;
            
            const orderBtn = document.getElementById('orderBtn');
            const originalText = orderBtn.innerHTML;
            
            // Loading-Status
            orderBtn.disabled = true;
            orderBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${window.t ? window.t('order.processing') : 'Bestellung wird verarbeitet...'}`;
            
            try {
                // Bestelldaten vorbereiten
                const orderData = {
                    id: generateOrderId(),
                    timestamp: new Date().toISOString(),
                    items: Object.entries(cart).map(([productId, quantity]) => ({
                        id: productId,
                        name: availableProducts[productId].name,
                        price: availableProducts[productId].price,
                        quantity: quantity
                    })),
                    total: Object.entries(cart).reduce((sum, [productId, quantity]) => {
                        return sum + (availableProducts[productId].price * quantity);
                    }, 0),
                    note: document.getElementById('orderNote').value.trim(),
                    status: 'neu',
                    waitTime: calculateWaitTime(),
                    paymentMethod: 'cash' // Default zu Barzahlung
                };

                // Bestellung zu Firebase senden
                const orderRef = await database.ref('orders').push(orderData);
                currentOrderId = orderRef.key;

                // Erfolg anzeigen
                const successText = window.t 
                    ? window.t('order.success', { id: orderData.id, time: orderData.waitTime })
                    : `‚úÖ Bestellung #${orderData.id} eingegangen! Gesch√§tzte Wartezeit: ${orderData.waitTime} Min`;
                
                showNotification(successText, 'success');

                // Warenkorb leeren
                cart = {};
                updateCartDisplay();
                
                // Tracking-Popup anzeigen
                setTimeout(() => {
                    showTrackingPopup();
                }, 2000);

            } catch (error) {
                console.error('Fehler beim Aufgeben der Bestellung:', error);
                const errorText = window.t 
                    ? window.t('order.error')
                    : 'Fehler bei der Bestellung. Bitte versuchen Sie es erneut.';
                showNotification(errorText, 'error');
            } finally {
                orderBtn.disabled = false;
                orderBtn.innerHTML = originalText;
            }
        }

        // BESTELLNUMMER GENERIEREN
        function generateOrderId() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            return `${hours}${minutes}${random}`;
        }

        // WARTEZEIT BERECHNEN
        function calculateWaitTime() {
            const totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
            
            if (totalItems < 6) {
                return Math.max(currentWaitTime, 5);
            } else if (totalItems < 12) {
                return Math.max(currentWaitTime, 10);
            } else {
                const extraTime = Math.ceil((totalItems - 12) / 3) * 5;
                return Math.max(currentWaitTime, 10 + extraTime);
            }
        }

        // NOTIFICATION LISTENER SETUP
        function setupNotificationListener() {
            if (!currentOrderId) return;
            
            database.ref(`notifications/${currentOrderId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                showNotification(notification.message, 'info', notification.playSound);
            });
        }

        // NOTIFICATION ANZEIGEN
        function showNotification(message, type = 'info', playSound = false) {
            const notification = document.getElementById('notificationPopup');
            const messageSpan = document.getElementById('notificationMessage');
            
            messageSpan.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i> 
                ${message}
            `;
            notification.className = `notification-popup ${type} show`;
            
            if (playSound) {
                playNotificationSound();
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // NOTIFICATION SOUND
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
            } catch (error) {
                console.log('Sound nicht verf√ºgbar:', error);
            }
        }

        // TRACKING POPUP ANZEIGEN
        function showTrackingPopup() {
            document.getElementById('orderTrackingPopup').style.display = 'flex';
        }

        // TRACKING POPUP SCHLIESSEN
        function closeTrackingPopup() {
            document.getElementById('orderTrackingPopup').style.display = 'none';
        }

        // TRACKING SEITE √ñFFNEN
        function openTrackingPage() {
            if (currentOrderId) {
                window.open(`track.html?order=${currentOrderId}`, '_blank');
            }
            closeTrackingPopup();
        }

        // DEMO PRODUKTE ERSTELLEN (nur wenn keine vorhanden)
        function createDemoProducts() {
            const demoProducts = {
                'margherita': {
                    name: 'Pizza Margherita',
                    description: 'Klassische Pizza mit Tomaten, Mozzarella und frischem Basilikum',
                    price: 18.50,
                    category: 'pizza',
                    available: true
                },
                'quattro-stagioni': {
                    name: 'Pizza Quattro Stagioni',
                    description: 'Mit Champignons, Artischocken, Schinken und Oliven',
                    price: 22.50,
                    category: 'pizza',
                    available: true
                },
                'carbonara': {
                    name: 'Pasta Carbonara',
                    description: 'Cremige Pasta mit Pancetta, Ei und Parmesan',
                    price: 19.00,
                    category: 'pasta',
                    available: true
                },
                'puttanesca': {
                    name: 'Pasta Puttanesca',
                    description: 'W√ºrzige Pasta mit Tomaten, Oliven, Kapern und Anchovis',
                    price: 20.50,
                    category: 'pasta',
                    available: true
                }
            };

            // Nur erstellen wenn keine Produkte vorhanden
            database.ref('products').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('products').set(demoProducts);
                    console.log('Demo-Produkte erstellt');
                }
            });
        }

        // Demo-Produkte erstellen beim ersten Laden
        setTimeout(createDemoProducts, 1000);

        console.log('Pizza&Pasta D\'amico Customer Interface geladen!');
    </script>
</body>
</html>