<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza&Pasta D'amico - Online Bestellen</title>
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="js/multilingual.js"></script>
</head>
<body>
    <!-- Pizza Loader -->
    <div class="pizza-loader" id="pizzaLoader">
        <div class="spinning-pizza">üçï</div>
        <div class="loading-text">Pizza&Pasta D'amico</div>
        <div class="loading-subtext" data-i18n="loading">Men√º wird geladen...</div>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
        <!-- Wird von multilingual.js generiert -->
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üçï Pizza&Pasta D'amico</h1>
            <p class="subtitle" data-i18n="header.subtitle">Authentisch italienisch seit 1985</p>
            <div class="location-info">
                <i class="fas fa-map-marker-alt"></i>
                <span data-i18n="header.location">Foodtruck am Marktplatz</span>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Wait Time Banner -->
            <div class="wait-time-banner" id="waitTimeBanner">
                <i class="fas fa-clock"></i>
                <span data-i18n="waitTime.current">Aktuelle Wartezeit:</span>
                <strong id="currentWaitTime">5</strong>
                <span data-i18n="waitTime.minutes">Minuten</span>
            </div>

            <!-- Status Badges -->
            <div class="status-badges">
                <span class="status-badge active" id="openStatus">
                    <i class="fas fa-door-open"></i>
                    <span data-i18n="status.open">Ge√∂ffnet</span>
                </span>
                <span class="status-badge" id="closedStatus" style="display: none;">
                    <i class="fas fa-door-closed"></i>
                    <span data-i18n="status.closed">Geschlossen</span>
                </span>
                <span class="status-badge">
                    <i class="fas fa-truck"></i>
                    <span data-i18n="status.delivery">Nur Abholung</span>
                </span>
            </div>

            <!-- Closed Notice -->
            <div class="closed-notice" id="closedNotice" style="display: none;">
                <div class="status-emoji">üò¥</div>
                <h2 class="status-title" data-i18n="closed.title">Momentan geschlossen</h2>
                <p class="status-description" data-i18n="closed.message">
                    Wir sind gerade nicht verf√ºgbar. Bitte versuchen Sie es sp√§ter erneut.
                </p>
            </div>

            <!-- Category Tabs -->
            <div class="category-tabs" id="categoryTabs">
                <button class="category-tab active" onclick="filterByCategory('all')">
                    <i class="fas fa-th"></i>
                    <span data-i18n="category.all">Alle</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('pizza')">
                    <i class="fas fa-pizza-slice"></i>
                    <span data-i18n="category.pizza">Pizza</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('pasta')">
                    <i class="fas fa-utensils"></i>
                    <span data-i18n="category.pasta">Pasta</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('drinks')">
                    <i class="fas fa-glass-martini"></i>
                    <span data-i18n="category.drinks">Getr√§nke</span>
                </button>
                <button class="category-tab" onclick="filterByCategory('desserts')">
                    <i class="fas fa-ice-cream"></i>
                    <span data-i18n="category.desserts">Desserts</span>
                </button>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="productsContainer">
                <!-- Wird dynamisch gef√ºllt -->
            </div>

            <!-- Cart -->
            <div class="cart-section" id="cartSection">
                <h2 class="cart-title">
                    <i class="fas fa-shopping-cart"></i>
                    <span data-i18n="cart.title">Warenkorb</span>
                </h2>
                
                <div id="cartEmpty" class="empty-cart">
                    <i class="fas fa-shopping-basket"></i>
                    <p data-i18n="cart.empty">Ihr Warenkorb ist leer</p>
                </div>
                
                <div id="cartItems" class="cart-items" style="display: none;">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
                
                <div id="cartTotals" class="cart-totals" style="display: none;">
                    <div class="cart-total-row">
                        <span data-i18n="cart.subtotal">Zwischensumme:</span>
                        <span id="subtotal">CHF 0.00</span>
                    </div>
                    <div class="cart-total-row final">
                        <span data-i18n="cart.total">Gesamtbetrag:</span>
                        <span id="total">CHF 0.00</span>
                    </div>
                </div>
                
                <button class="order-btn" id="orderButton" onclick="showCheckout()" disabled>
                    <i class="fas fa-credit-card"></i>
                    <span data-i18n="cart.checkout">Zur Kasse</span>
                </button>
            </div>

            <!-- Admin Link -->
            <div class="admin-section">
                <p data-i18n="footer.adminHint">Sind Sie ein Administrator?</p>
                <a href="admin.html" class="admin-login-btn">
                    <i class="fas fa-user-shield"></i>
                    <span data-i18n="footer.adminLogin">Zum Admin-Bereich</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="checkout.title">Bestellung abschlie√üen</h3>
                <button class="modal-close" onclick="closeCheckout()">√ó</button>
            </div>
            <form id="checkoutForm" onsubmit="processCheckout(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" data-i18n="checkout.name">Name *</label>
                        <input type="text" id="customerName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="checkout.phone">Telefon *</label>
                        <input type="tel" id="customerPhone" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="checkout.email">E-Mail (optional)</label>
                        <input type="email" id="customerEmail" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-i18n="checkout.notes">Bemerkungen</label>
                        <textarea id="orderNotes" class="form-textarea" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCheckout()">
                        <span data-i18n="checkout.cancel">Abbrechen</span>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        <span data-i18n="checkout.confirm">Bestellung aufgeben</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="payment.title">Zahlungsmethode w√§hlen</h3>
                <button class="modal-close" onclick="closePayment()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-options">
                    <button class="payment-option" onclick="selectPayment('card')">
                        <i class="fas fa-credit-card"></i>
                        <span data-i18n="payment.card">Kartenzahlung</span>
                        <small data-i18n="payment.cardDesc">Visa, Mastercard, etc.</small>
                    </button>
                    
                    <button class="payment-option" onclick="selectPayment('cash')">
                        <i class="fas fa-money-bill-wave"></i>
                        <span data-i18n="payment.cash">Barzahlung</span>
                        <small data-i18n="payment.cashDesc">Bei Abholung bezahlen</small>
                    </button>
                    
                    <button class="payment-option disabled">
                        <i class="fas fa-mobile-alt"></i>
                        <span data-i18n="payment.twint">TWINT</span>
                        <small data-i18n="payment.comingSoon">Bald verf√ºgbar</small>
                        <span class="coming-soon-badge">Coming Soon</span>
                    </button>
                </div>
                
                <div class="order-summary">
                    <h4 data-i18n="payment.summary">Bestell√ºbersicht</h4>
                    <div id="paymentSummary"></div>
                    <div class="order-total">
                        <span data-i18n="payment.total">Gesamtbetrag:</span>
                        <span id="paymentTotal">CHF 0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-check-circle"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Firebase Konfiguration
       const firebaseConfig = {
  apiKey: "AIzaSyD3OCMvc4Iup58Ao0BiFNuvA0fnJokzYS8",
  authDomain: "pizzapastadamico.firebaseapp.com",
  databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pizzapastadamico",
  storageBucket: "pizzapastadamico.firebasestorage.app",
  messagingSenderId: "83240541532",
  appId: "1:83240541532:web:11e3277850bf89a5b8b599",
  measurementId: "G-6H2J5K88J7"
};

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Stripe initialisieren
        const stripe = Stripe('YOUR_STRIPE_PUBLIC_KEY');

        // Globale Variablen
        let cart = [];
        let products = [];
        let currentCategory = 'all';
        let isOpen = true;
        let currentWaitTime = 5;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loader after delay
            setTimeout(() => {
                document.getElementById('pizzaLoader').style.display = 'none';
            }, 1500);

            // Load multilingual
            if (window.ml) {
                window.ml.init();
            }

            // Load products
            loadProducts();
            
            // Listen to settings
            listenToSettings();
            
            // Load cart from localStorage
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                updateCart();
            }
        });

        // Load Products
        function loadProducts() {
            database.ref('products').on('value', (snapshot) => {
                products = [];
                
                snapshot.forEach((child) => {
                    const product = { id: child.key, ...child.val() };
                    if (product.available !== false) {
                        products.push(product);
                    }
                });
                
                // Create demo products if empty
                if (products.length === 0) {
                    createDemoProducts();
                } else {
                    displayProducts();
                }
            });
        }

        // Display Products
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            let filteredProducts = products;
            
            if (currentCategory !== 'all') {
                filteredProducts = products.filter(p => p.category === currentCategory);
            }
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-pizza-slice"></i>
                        <p data-i18n="products.none">Keine Produkte in dieser Kategorie</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="product-emoji">${product.emoji || getCategoryEmoji(product.category)}</div>
                    <div class="product-details">
                        <h3 class="product-name">${product.name}</h3>
                        ${product.description ? `<p class="product-description">${product.description}</p>` : ''}
                        <div class="product-footer">
                            <span class="product-price">CHF ${product.price.toFixed(2)}</span>
                            <div class="quantity-controls">
                                ${getQuantityControls(product.id)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get Quantity Controls
        function getQuantityControls(productId) {
            const cartItem = cart.find(item => item.id === productId);
            const quantity = cartItem ? cartItem.quantity : 0;
            
            if (quantity === 0) {
                return `
                    <button class="quantity-btn add" onclick="addToCart('${productId}')">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
            }
            
            return `
                <button class="quantity-btn" onclick="updateQuantity('${productId}', ${quantity - 1})">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="quantity-display">${quantity}</span>
                <button class="quantity-btn" onclick="updateQuantity('${productId}', ${quantity + 1})">
                    <i class="fas fa-plus"></i>
                </button>
            `;
        }

        // Add to Cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                quantity: 1
            });
            
            updateCart();
            displayProducts();
            showNotification(`${product.name} wurde zum Warenkorb hinzugef√ºgt`);
        }

        // Update Quantity
        function updateQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            } else {
                const item = cart.find(item => item.id === productId);
                if (item) {
                    item.quantity = newQuantity;
                }
            }
            
            updateCart();
            displayProducts();
        }

        // Update Cart
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartEmpty = document.getElementById('cartEmpty');
            const cartTotals = document.getElementById('cartTotals');
            const orderButton = document.getElementById('orderButton');
            
            if (cart.length === 0) {
                cartItems.style.display = 'none';
                cartTotals.style.display = 'none';
                cartEmpty.style.display = 'block';
                orderButton.disabled = true;
            } else {
                cartEmpty.style.display = 'none';
                cartItems.style.display = 'block';
                cartTotals.style.display = 'block';
                orderButton.disabled = false;
                
                // Display cart items
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-quantity">${item.quantity}x CHF ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-price">CHF ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `).join('');
                
                // Calculate totals
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                document.getElementById('subtotal').textContent = `CHF ${total.toFixed(2)}`;
                document.getElementById('total').textContent = `CHF ${total.toFixed(2)}`;
            }
            
            // Save cart
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        // Filter by Category
        function filterByCategory(category) {
            currentCategory = category;
            
            // Update tab states
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.category-tab').classList.add('active');
            
            displayProducts();
        }

        // Listen to Settings
        function listenToSettings() {
            // Restaurant status
            database.ref('settings/isOpen').on('value', (snapshot) => {
                isOpen = snapshot.val() !== false;
                
                const openStatus = document.getElementById('openStatus');
                const closedStatus = document.getElementById('closedStatus');
                const closedNotice = document.getElementById('closedNotice');
                const categoryTabs = document.getElementById('categoryTabs');
                const productsContainer = document.getElementById('productsContainer');
                const cartSection = document.getElementById('cartSection');
                
                if (isOpen) {
                    openStatus.style.display = '';
                    closedStatus.style.display = 'none';
                    closedNotice.style.display = 'none';
                    categoryTabs.style.display = '';
                    productsContainer.style.display = '';
                    cartSection.style.display = '';
                } else {
                    openStatus.style.display = 'none';
                    closedStatus.style.display = '';
                    closedNotice.style.display = 'block';
                    categoryTabs.style.display = 'none';
                    productsContainer.style.display = 'none';
                    cartSection.style.display = 'none';
                }
            });
            
            // Wait time
            database.ref('settings/waitTime').on('value', (snapshot) => {
                currentWaitTime = snapshot.val() || 5;
                document.getElementById('currentWaitTime').textContent = currentWaitTime;
            });
        }

        // Checkout Functions
        function showCheckout() {
            if (!isOpen || cart.length === 0) return;
            document.getElementById('checkoutModal').classList.add('active');
        }

        function closeCheckout() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        function processCheckout(event) {
            event.preventDefault();
            
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                notes: document.getElementById('orderNotes').value
            };
            
            // Save customer data temporarily
            sessionStorage.setItem('customerData', JSON.stringify(customerData));
            
            // Close checkout and show payment
            closeCheckout();
            showPayment();
        }

        function showPayment() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Update payment summary
            document.getElementById('paymentSummary').innerHTML = cart.map(item => `
                <div class="payment-item">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>CHF ${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById('paymentTotal').textContent = `CHF ${total.toFixed(2)}`;
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePayment() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function selectPayment(method) {
            const customerData = JSON.parse(sessionStorage.getItem('customerData'));
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (method === 'card') {
                processCardPayment(customerData, total);
            } else if (method === 'cash') {
                processCashPayment(customerData, total);
            }
        }

        async function processCardPayment(customerData, total) {
            showNotification('Weiterleitung zur Zahlung...', 'info');
            
            // Create order in Firebase
            const orderData = {
                ...customerData,
                items: cart,
                total: total,
                paymentMethod: 'card',
                status: 'neu',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                waitTime: calculateWaitTime()
            };
            
            const orderRef = await database.ref('orders').push(orderData);
            
            // Here would be Stripe integration
            // For demo, simulate success
            setTimeout(() => {
                window.location.href = `success.html?order=${orderRef.key}`;
            }, 1000);
        }

        async function processCashPayment(customerData, total) {
            showNotification('Bestellung wird verarbeitet...', 'info');
            
            // Create order in Firebase
            const orderData = {
                ...customerData,
                items: cart,
                total: total,
                paymentMethod: 'cash',
                status: 'neu',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                waitTime: calculateWaitTime()
            };
            
            const orderRef = await database.ref('orders').push(orderData);
            
            // Clear cart and redirect
            localStorage.removeItem('cart');
            window.location.href = `success.html?order=${orderRef.key}`;
        }

        // Utility Functions
        function calculateWaitTime() {
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (itemCount < 6) return 5;
            if (itemCount <= 11) return 10;
            return Math.min(15 + Math.floor((itemCount - 11) / 3) * 5, 30);
        }

        function getCategoryEmoji(category) {
            const emojis = {
                pizza: 'üçï',
                pasta: 'üçù',
                drinks: 'ü•§',
                desserts: 'üç∞'
            };
            return emojis[category] || 'üçΩÔ∏è';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Create Demo Products
        function createDemoProducts() {
            const demoProducts = [
                { name: 'Pizza Margherita', category: 'pizza', price: 18.50, emoji: 'üçï', description: 'Tomaten, Mozzarella, Basilikum' },
                { name: 'Pizza Salami', category: 'pizza', price: 21.00, emoji: 'üçï', description: 'Tomaten, Mozzarella, Salami' },
                { name: 'Pasta Carbonara', category: 'pasta', price: 19.50, emoji: 'üçù', description: 'Speck, Ei, Parmesan' },
                { name: 'Pasta Arrabbiata', category: 'pasta', price: 17.00, emoji: 'üçù', description: 'Tomaten, Knoblauch, Chili' },
                { name: 'Coca Cola', category: 'drinks', price: 4.50, emoji: 'ü•§', description: '0.5L' },
                { name: 'Wasser', category: 'drinks', price: 3.50, emoji: 'üíß', description: '0.5L' },
                { name: 'Tiramisu', category: 'desserts', price: 8.50, emoji: 'üç∞', description: 'Hausgemacht' },
                { name: 'Panna Cotta', category: 'desserts', price: 7.50, emoji: 'üçÆ', description: 'Mit Beerensauce' }
            ];
            
            demoProducts.forEach(product => {
                database.ref('products').push(product);
            });
        }
    </script>
</body>
</html>