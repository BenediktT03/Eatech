rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isTenantOwner(tenantId) {
      return isAuthenticated() && 
        get(/databases//documents/tenants/).data.ownerId == request.auth.uid;
    }
    
    function isTenantStaff(tenantId) {
      return isAuthenticated() && 
        exists(/databases//documents/tenants//staff/);
    }
    
    function canAccessTenant(tenantId) {
      return isTenantOwner(tenantId) || isTenantStaff(tenantId);
    }
    
    function isMasterAdmin() {
      return isAuthenticated() && 
        exists(/databases//documents/masterUsers/);
    }
    
    // Master Control Rules
    match /masterUsers/{userId} {
      allow read, write: if isMasterAdmin();
    }
    
    match /systemConfig/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isMasterAdmin();
    }
    
    match /platformAnalytics/{document=**} {
      allow read: if isMasterAdmin();
      allow write: if false; // Only server can write
    }
    
    // Tenant Rules
    match /tenants/{tenantId} {
      allow read: if true; // Public tenant info
      allow create: if isAuthenticated();
      allow update: if canAccessTenant(tenantId);
      allow delete: if isTenantOwner(tenantId) || isMasterAdmin();
      
      // Products
      match /products/{productId} {
        allow read: if true; // Public menu
        allow write: if canAccessTenant(tenantId);
      }
      
      // Orders
      match /orders/{orderId} {
        allow read: if canAccessTenant(tenantId) || 
          (isAuthenticated() && resource.data.customer.firebaseUid == request.auth.uid);
        allow create: if true; // Anyone can place order
        allow update: if canAccessTenant(tenantId) || 
          (isAuthenticated() && resource.data.customer.firebaseUid == request.auth.uid && 
           resource.data.status == 'pending');
        allow delete: if false; // No order deletion
      }
      
      // Staff
      match /staff/{staffId} {
        allow read: if canAccessTenant(tenantId);
        allow write: if isTenantOwner(tenantId);
      }
      
      // Analytics
      match /analytics/{document=**} {
        allow read: if canAccessTenant(tenantId);
        allow write: if false; // Only server
      }
      
      // Settings
      match /settings/{document=**} {
        allow read: if canAccessTenant(tenantId);
        allow write: if isTenantOwner(tenantId);
      }
    }
    
    // Customer Data
    match /customers/{customerId} {
      allow read: if isAuthenticated() && request.auth.uid == customerId;
      allow create: if isAuthenticated() && request.auth.uid == customerId;
      allow update: if isAuthenticated() && request.auth.uid == customerId;
      allow delete: if false; // DSGVO compliance through cloud function
    }
    
    // Reviews
    match /reviews/{reviewId} {
      allow read: if true; // Public reviews
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
  }
}
